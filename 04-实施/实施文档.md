# 综合布线记录管理系统 - 实施文档

## 文档信息
- **文档版本**: v1.0.0
- **创建日期**: 2025-01-04
- **适用系统**: 综合布线记录管理系统
- **目标读者**: 系统管理员、运维人员、开发人员

---

## 目录
1. [项目概述](#1-项目概述)
2. [系统架构](#2-系统架构)
3. [环境要求](#3-环境要求)
4. [快速开始](#4-快速开始)
5. [详细安装步骤](#5-详细安装步骤)
6. [系统配置](#6-系统配置)
7. [使用说明](#7-使用说明)
8. [常见问题](#8-常见问题)
9. [系统维护](#9-系统维护)
10. [技术支持](#10-技术支持)

---

## 1. 项目概述

### 1.1 系统简介
综合布线记录管理系统是一个用于管理和维护数据中心、机房等场所布线信息的管理系统。系统支持Excel文件导入、数据查询、记录导出等功能，帮助用户高效管理布线记录。

### 1.2 主要功能
- **文件上传**: 支持Excel文件批量导入布线记录
- **数据查询**: 支持多条件查询布线记录
- **记录导出**: 支持将查询结果导出为Excel文件
- **跳纤统计**: 提供各机房跳纤数量的可视化统计和状态分析（US-006）
- **重复处理**: 上传时自动检测重复记录并执行替换更新（US-005）
- **历史记录**: 记录所有操作历史，便于追溯

### 1.3 技术栈
- **前端**: Vue 3 + TypeScript + Element Plus + Vite
- **后端**: Node.js + Express + TypeScript + SQLite
- **容器化**: Docker + Docker Compose
- **Web服务器**: Nginx

---

## 2. 系统架构

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        用户浏览器                             │
│                  (Chrome/Firefox/Safari)                     │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTP (Port 80)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    Frontend Container                        │
│                   (Nginx + Vue.js SPA)                       │
│                   Port: 80 (Host) → 80 (Container)          │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTP (Internal Network)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    Backend Container                         │
│              (Node.js + Express + SQLite)                   │
│                   Port: 3001 (Host → Container)             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   Data Volume                                │
│              (SQLite Database + Uploads)                     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构
```
sjzx-zonghebuxian/
├── backend/              # 后端服务
│   ├── src/             # 源代码
│   │   ├── config/      # 配置文件
│   │   ├── controllers/ # 控制器
│   │   ├── models/      # 数据模型
│   │   ├── routes/      # 路由
│   │   ├── services/    # 业务逻辑
│   │   └── types/       # 类型定义
│   ├── data/            # 数据库文件（运行时生成）
│   ├── uploads/         # 上传文件（运行时生成）
│   ├── Dockerfile       # Docker镜像构建文件
│   └── package.json     # 依赖配置
│
├── frontend/            # 前端应用
│   ├── src/             # 源代码
│   │   ├── components/  # 组件
│   │   ├── router/      # 路由配置
│   │   ├── services/    # API服务
│   │   ├── types/       # 类型定义
│   │   └── views/       # 页面组件
│   ├── Dockerfile       # Docker镜像构建文件
│   ├── nginx.conf       # Nginx配置
│   └── package.json     # 依赖配置
│
├── config/              # 配置文件
│   └── docker-compose.yml  # Docker编排配置
│
└── 04-实施/             # 实施文档（本目录）
    └── 实施文档.md
```

### 2.3 数据库设计

#### 2.3.1 数据库表：records（布线记录表）

```sql
CREATE TABLE records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    record_number TEXT NOT NULL,           -- 登记表编号
    datacenter_name TEXT NOT NULL,         -- 机房名称
    idc_requirement_number TEXT,          -- IDC需求编号
    yes_ticket_number TEXT,                -- YES工单编号
    user_unit TEXT,                        -- 用户单位
    cable_type TEXT,                       -- 线缆类型
    operator TEXT,                         -- 运营商
    circuit_number TEXT,                   -- 线路编号
    contact_person TEXT,                   -- 报障人/联系方式
    start_port TEXT,                       -- 起始端口（A端）
    hop1 TEXT,                            -- 一跳
    hop2 TEXT,                            -- 二跳
    hop3 TEXT,                            -- 三跳
    hop4 TEXT,                            -- 四跳
    hop5 TEXT,                            -- 五跳
    end_port TEXT,                         -- 目标端口（Z端）
    user_cabinet TEXT,                     -- 用户机柜
    label_complete INTEGER DEFAULT 0,       -- 线路标签是否齐全 (0:否, 1:是)
    cable_standard INTEGER DEFAULT 0,         -- 线路是否规范 (0:否, 1:是)
    status TEXT DEFAULT 'active',          -- 线路状态 (active:在用, removed:已拆除) - US-006
    remark TEXT,                           -- 备注
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_datacenter_name ON records(datacenter_name);
CREATE INDEX idx_record_number ON records(record_number);
CREATE INDEX idx_circuit_number ON records(circuit_number);
CREATE INDEX idx_start_port ON records(start_port);
CREATE INDEX idx_end_port ON records(end_port);
CREATE INDEX idx_user_cabinet ON records(user_cabinet);
CREATE INDEX idx_operator ON records(operator);
CREATE INDEX idx_cable_type ON records(cable_type);
CREATE INDEX idx_status ON records(status);

-- 重复识别索引（用于US-005重复记录处理）
CREATE INDEX idx_idc_requirement_number ON records(idc_requirement_number);
CREATE INDEX idx_yes_ticket_number ON records(yes_ticket_number);
CREATE UNIQUE INDEX idx_unique_record ON records(
    COALESCE(idc_requirement_number, ''),
    COALESCE(yes_ticket_number, ''),
    COALESCE(circuit_number, ''),
    COALESCE(record_number, ''),
    datacenter_name
);
```

#### 2.3.2 数据库表：operation_logs（操作日志表）

```sql
CREATE TABLE operation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operation_type TEXT NOT NULL,           -- 操作类型：INSERT, UPDATE, DELETE
    record_id INTEGER,                       -- 记录ID
    record_number TEXT,                      -- 登记表编号
    idc_requirement_number TEXT,             -- IDC需求编号
    yes_ticket_number TEXT,                  -- YES工单编号
    circuit_number TEXT,                     -- 线路编号
    datacenter_name TEXT,                    -- 机房名称
    operation_detail TEXT,                   -- 操作详情（JSON格式）
    old_data TEXT,                           -- 旧数据（JSON格式，仅UPDATE操作）
    new_data TEXT,                           -- 新数据（JSON格式）
    operator TEXT,                           -- 操作人
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_operation_type ON operation_logs(operation_type);
CREATE INDEX idx_record_id ON operation_logs(record_id);
CREATE INDEX idx_created_at ON operation_logs(created_at);
```

#### 2.3.3 数据库字段说明

**records表字段说明：**
- `id`: 主键，自增
- `record_number`: 登记表编号，唯一标识
- `datacenter_name`: 机房名称，用于分组统计
- `idc_requirement_number`: IDC需求编号，重复识别优先级1
- `yes_ticket_number`: YES工单编号，重复识别优先级2
- `user_unit`: 用户单位
- `cable_type`: 线缆类型（单模光纤、多模光纤、网线）
- `operator`: 运营商（OCN、电信、移动、联通）
- `circuit_number`: 线路编号，重复识别优先级3
- `contact_person`: 报障人/联系方式
- `start_port`: 起始端口（A端）
- `hop1-hop5`: 跳纤路径（一跳到五跳）
- `end_port`: 目标端口（Z端）
- `user_cabinet`: 用户机柜
- `label_complete`: 线路标签是否齐全（0:否, 1:是）
- `cable_standard`: 线路是否规范（0:否, 1:是）
- `status`: 线路状态（active:在用, removed:已拆除），用于跳纤统计
- `remark`: 备注
- `created_at`: 创建时间
- `updated_at`: 更新时间

**operation_logs表字段说明：**
- `id`: 主键，自增
- `operation_type`: 操作类型（INSERT, UPDATE, DELETE）
- `record_id`: 记录ID
- `record_number`: 登记表编号
- `idc_requirement_number`: IDC需求编号
- `yes_ticket_number`: YES工单编号
- `circuit_number`: 线路编号
- `datacenter_name`: 机房名称
- `operation_detail`: 操作详情（JSON格式）
- `old_data`: 旧数据（JSON格式，仅UPDATE操作）
- `new_data`: 新数据（JSON格式）
- `operator`: 操作人
- `created_at`: 创建时间

---

## 3. 环境要求

### 3.1 硬件要求
| 配置项 | 最低要求 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核及以上 |
| 内存 | 2GB | 4GB及以上 |
| 硬盘 | 20GB | 50GB及以上 |
| 网络 | 10Mbps | 100Mbps及以上 |

### 3.2 软件要求
| 软件 | 版本要求 | 说明 |
|------|----------|------|
| 操作系统 | Linux (Ubuntu 20.04+, CentOS 7+, Debian 10+) | 推荐Ubuntu 20.04 LTS |
| Docker | 20.10+ | 容器运行环境 |
| Docker Compose | 2.0+ | 容器编排工具 |
| Node.js | 18.0.0+ | 本地开发环境（可选） |
| npm | 9.0.0+ | 包管理器（可选） |

### 3.3 网络要求
- **开放端口**: 80 (HTTP), 443 (HTTPS, 可选)
- **网络延迟**: 内部网络延迟 < 10ms
- **带宽**: 最低10Mbps，推荐100Mbps

---

## 4. 快速开始

### 4.1 前提条件
确保服务器已安装Docker和Docker Compose。

### 4.2 一键部署（推荐）
使用项目根目录的自动化部署脚本：

```bash
# 1. 上传项目文件到服务器
# 2. 进入项目根目录
cd /path/to/sjzx-zonghebuxian

# 3. 给部署脚本添加执行权限
chmod +x deploy_自动部署.sh

# 4. 执行一键部署
./deploy_自动部署.sh
```

### 4.3 手动部署
如果需要手动部署，请参考[详细安装步骤](#5-详细安装步骤)。

### 4.4 验证部署
部署完成后，在浏览器中访问：
- **前端地址**: http://服务器IP地址
- **后端健康检查**: http://服务器IP地址:3001/health

---

## 5. 详细安装步骤

### 5.1 步骤1: 准备服务器

#### 5.1.1 更新系统
```bash
# Ubuntu/Debian
sudo apt-get update && sudo apt-get upgrade -y

# CentOS/RHEL
sudo yum update -y
```

#### 5.1.2 安装必要工具
```bash
# Ubuntu/Debian
sudo apt-get install -y curl wget git

# CentOS/RHEL
sudo yum install -y curl wget git
```

### 5.2 步骤2: 安装Docker

#### 5.2.1 安装Docker
```bash
# 使用官方脚本安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证Docker安装
docker --version
```

#### 5.2.2 安装Docker Compose
```bash
# 下载Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 添加执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

#### 5.2.3 配置Docker用户（可选）
```bash
# 将当前用户添加到docker组
sudo usermod -aG docker $USER

# 重新登录或执行以下命令使配置生效
newgrp docker
```

### 5.3 步骤3: 上传项目文件

#### 5.3.1 创建项目目录
```bash
# 创建项目目录
sudo mkdir -p /opt/sjzx-zonghebuxian

# 设置目录权限
sudo chown $USER:$USER /opt/sjzx-zonghebuxian
```

#### 5.3.2 上传文件
使用以下任一方式上传项目文件：

**方式1: 使用SCP**
```bash
# 在本地执行
scp -r sjzx-zonghebuxian user@server:/opt/
```

**方式2: 使用Git**
```bash
# 克隆项目
cd /opt
git clone <repository-url> sjzx-zonghebuxian
```

**方式3: 使用SFTP工具**
使用FileZilla、WinSCP等工具上传文件。

### 5.4 步骤4: 配置环境变量

#### 5.4.1 后端配置
创建 `.env` 文件：
```bash
cd /opt/sjzx-zonghebuxian/backend
cp .env.example .env
```

编辑 `.env` 文件，配置以下参数：
```env
PORT=3001
CORS_ORIGIN=http://localhost
DB_PATH=/app/data/wiring.db
UPLOAD_DIR=/app/uploads
```

#### 5.4.2 前端配置
创建 `.env` 文件：
```bash
cd /opt/sjzx-zonghebuxian/frontend
cp .env.example .env
```

编辑 `.env` 文件，配置以下参数：
```env
VITE_API_BASE_URL=http://localhost:3001
```

### 5.5 步骤5: 构建和启动服务

#### 5.5.1 创建数据目录
```bash
cd /opt/sjzx-zonghebuxian
mkdir -p backend/data backend/uploads
```

#### 5.5.2 构建Docker镜像
```bash
cd /opt/sjzx-zonghebuxian/config
docker-compose build
```

#### 5.5.3 启动服务
```bash
docker-compose up -d
```

#### 5.5.4 查看服务状态
```bash
docker-compose ps
```

### 5.6 步骤6: 验证部署

#### 5.6.1 检查容器状态
```bash
docker-compose ps
```

预期输出：
```
NAME                STATUS              PORTS
wiring-backend      Up (healthy)        0.0.0.0:3001->3001/tcp
wiring-frontend     Up                  0.0.0.0:80->80/tcp
```

#### 5.6.2 检查服务日志
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f frontend
```

#### 5.6.3 访问系统
在浏览器中访问：
- **前端地址**: http://服务器IP地址
- **后端API**: http://服务器IP地址:3001

---

## 6. 系统配置

### 6.1 端口配置

#### 6.1.1 修改前端端口
编辑 [config/docker-compose.yml](file:///d:\TREA\sjzx-zonghebuxian\config\docker-compose.yml)：
```yaml
frontend:
  ports:
    - "8080:80"  # 将80改为8080
```

#### 6.1.2 修改后端端口
编辑 [config/docker-compose.yml](file:///d:\TREA\sjzx-zonghebuxian\config\docker-compose.yml)：
```yaml
backend:
  ports:
    - "8081:3001"  # 将3001改为8081
```

### 6.2 数据库配置

#### 6.2.1 数据库路径
数据库文件存储在 `backend/data/wiring.db`，通过Docker卷挂载实现数据持久化。

#### 6.2.2 数据库备份
创建备份脚本：
```bash
#!/bin/bash
BACKUP_DIR="/backup/wiring"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
docker exec wiring-backend cp /app/data/wiring.db $BACKUP_DIR/wiring_$DATE.db

# 清理7天前的备份
find $BACKUP_DIR -name "*.db" -mtime +7 -delete
```

### 6.3 上传文件配置

#### 6.3.1 上传目录
上传的Excel文件存储在 `backend/uploads/` 目录。

#### 6.3.2 文件大小限制
默认最大上传文件大小为50MB，如需修改，编辑后端配置文件。

### 6.4 日志配置

#### 6.4.1 日志级别
日志级别可通过环境变量配置：
```env
LOG_LEVEL=info  # debug, info, warn, error
```

#### 6.4.2 日志轮转
Docker Compose默认配置日志轮转：
```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

---

## 7. API接口说明

### 7.1 记录查询接口

#### 7.1.1 获取记录列表
- **接口：** `GET /api/records`
- **参数：**
  - `page`: 页码（默认1）
  - `pageSize`: 每页数量（默认50）
  - `datacenterNames`: 机房名称数组（可选）
  - `keyword`: 关键字（可选）
  - `cableType`: 线缆类型（可选）
  - `operator`: 运营商（可选）
  - `labelComplete`: 标签齐全（可选）
  - `cableStandard`: 线路规范（可选）
- **返回：**
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": 1,
        "recordNumber": "WL-001",
        "datacenterName": "临港机房",
        "userUnit": "东方有线",
        "circuitNumber": "4705764620ShH",
        "startPort": "丽正路老芦公路光交",
        "endPort": "101机房G01"
      }
    ],
    "total": 156,
    "page": 1,
    "pageSize": 50
  }
}
```

#### 7.1.2 获取记录详情
- **接口：** `GET /api/records/:id`
- **参数：**
  - `id`: 记录ID
- **返回：**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "recordNumber": "WL-001",
    "datacenterName": "临港机房",
    "idcRequirementNumber": "RWD-20250805-065",
    "yesTicketNumber": "QTJF-202508-2354",
    "userUnit": "东方有线",
    "cableType": "单模光纤",
    "operator": "OCN",
    "circuitNumber": "4705764620ShH",
    "contactPerson": "400-884-1883",
    "startPort": "丽正路老芦公路光交",
    "hop1": "接入间A-A01-ODF3-1/2",
    "hop2": "接入间A-A04-ODF3-1#1/2",
    "hop3": "-",
    "hop4": "-",
    "hop5": "-",
    "endPort": "101机房G01",
    "userCabinet": "-",
    "labelComplete": 1,
    "cableStandard": 1,
    "remark": "-",
    "createdAt": "2025-12-24 10:30:00"
  }
}
```

### 7.2 文件上传接口

#### 7.2.1 上传文件
- **接口：** `POST /api/upload`
- **参数：**
  - `file`: Excel文件
- **返回：**
```json
{
  "success": true,
  "data": {
    "fileId": "1234567890",
    "fileName": "临港机房布线记录.xlsx",
    "recordCount": 25
  }
}
```

### 7.3 文件解析接口

#### 7.3.1 解析文件
- **接口：** `POST /api/parse`
- **参数：**
```json
{
  "fileId": "1234567890"
}
```
- **返回：**
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "datacenterName": "临港机房",
        "userUnit": "东方有线",
        "circuitNumber": "4705764620",
        "startPort": "丽正路...",
        "endPort": "101机房"
      }
    ],
    "total": 25
  }
}
```

### 7.4 保存记录接口

#### 7.4.1 保存记录
- **接口：** `POST /api/records`
- **参数：**
```json
{
  "fileId": "1234567890",
  "records": [
    {
      "datacenterName": "临港机房",
      "userUnit": "东方有线",
      "circuitNumber": "4705764620",
      "startPort": "丽正路...",
      "endPort": "101机房"
    }
  ]
}
```
- **返回：**
```json
{
  "success": true,
  "data": {
    "savedCount": 25,
    "updatedCount": 10,
    "failedCount": 0,
    "duplicateRecords": [
      {
        "idcRequirementNumber": "RWD-20250805-065",
        "yesTicketNumber": "QTJF-202508-2354",
        "circuitNumber": "4705764620",
        "operation": "UPDATE"
      }
    ]
  }
}
```

**重复处理说明（US-005）：**
- 系统自动检测重复记录
- 重复识别优先级：
  1. 任务单需求编号（IDC需求编号）
  2. YES工单编号
  3. 链路编号（线路编号）
  4. 登记表编号
  5. 组合键：机房名称 + 线路编号
  6. 组合键：机房名称 + 用户单位 + 线路编号
- 发现重复时执行UPDATE操作，保留原记录的created_at，更新updated_at
- 非重复记录执行INSERT操作
- 记录所有操作到operation_logs表

### 7.5 跳纤统计接口（US-006）

#### 7.5.1 获取跳纤统计
- **接口：** `GET /api/statistics/fiber`
- **参数：**
  - `datacenterName`: 机房名称（可选）
  - `status`: 线路状态（可选，all/active/removed）
- **返回：**
```json
{
  "success": true,
  "data": {
    "statistics": [
      {
        "datacenterName": "临港机房",
        "totalCount": 45,
        "activeCount": 38,
        "removedCount": 7,
        "activePercentage": 84.44,
        "removedPercentage": 15.56
      },
      {
        "datacenterName": "金桥机房",
        "totalCount": 32,
        "activeCount": 28,
        "removedCount": 4,
        "activePercentage": 87.5,
        "removedPercentage": 12.5
      }
    ],
    "summary": {
      "totalDatacenters": 7,
      "totalCount": 156,
      "activeCount": 132,
      "removedCount": 24
    }
  }
}
```

#### 7.5.2 获取机房跳纤详情
- **接口：** `GET /api/statistics/fiber/:datacenterName`
- **参数：**
  - `datacenterName`: 机房名称
  - `status`: 线路状态（可选，all/active/removed）
  - `page`: 页码（默认1）
  - `pageSize`: 每页数量（默认50）
- **返回：**
```json
{
  "success": true,
  "data": {
    "datacenterName": "临港机房",
    "records": [
      {
        "id": 1,
        "recordNumber": "WL-001",
        "circuitNumber": "4705764620",
        "startPort": "丽正路老芦公路光交",
        "endPort": "101机房G01",
        "status": "active",
        "userUnit": "东方有线"
      }
    ],
    "total": 45,
    "activeCount": 38,
    "removedCount": 7,
    "page": 1,
    "pageSize": 50
  }
}
```

#### 7.5.3 导出跳纤统计报表
- **接口：** `GET /api/statistics/fiber/export`
- **参数：**
  - `datacenterName`: 机房名称（可选）
  - `status`: 线路状态（可选，all/active/removed）
- **返回：**
  - Excel文件下载

### 7.6 导出记录接口

#### 7.6.1 导出记录
- **接口：** `GET /api/records/export`
- **参数：**
  - `datacenterNames`: 机房名称数组（可选）
  - `keyword`: 关键字（可选）
  - `cableType`: 线缆类型（可选）
  - `operator`: 运营商（可选）
  - `labelComplete`: 标签齐全（可选）
  - `cableStandard`: 线路规范（可选）
- **返回：**
  - Excel文件下载

---

## 8. 使用说明

### 8.1 系统登录

#### 8.1.1 访问系统
在浏览器中输入服务器IP地址，例如：
```
http://192.168.1.100
```

#### 8.1.2 首次使用
首次使用时，系统会自动创建数据库，无需手动初始化。

### 8.2 上传布线记录

#### 8.2.1 准备Excel文件
确保Excel文件符合以下格式：
- 第一行为表头
- 包含必要的字段（用户名称、机房、楼号、楼层等）
- 支持多个工作表

#### 8.2.2 上传步骤
1. 点击"上传文件"菜单
2. 选择Excel文件
3. 点击"上传"按钮
4. 等待上传和解析完成
5. 查看上传结果

#### 8.2.3 查看处理结果
上传完成后，系统会显示处理统计：
- 新增记录数
- 更新记录数（重复记录）
- 失败记录数
- 重复记录列表

### 8.3 查询布线记录

#### 8.3.1 基本查询
1. 点击"布线记录"菜单
2. 在查询表单中输入查询条件
3. 点击"查询"按钮
4. 查看查询结果

#### 8.3.2 支持的查询条件
- 用户名称
- 机房名称
- 楼号
- 楼层
- 执行日期

### 8.4 导出布线记录

#### 8.4.1 导出步骤
1. 在查询结果页面
2. 点击"导出"按钮
3. 系统将导出当前查询结果
4. 下载Excel文件

### 8.5 查看记录详情

#### 8.5.1 查看详情
1. 在记录列表中点击某条记录
2. 查看详细信息
3. 可进行编辑或删除操作

### 8.6 跳纤统计功能（US-006）

#### 8.6.1 查看跳纤统计
1. 点击"跳纤统计"菜单
2. 系统自动加载所有机房的统计数据
3. 查看汇总统计信息和统计卡片网格
4. 每个机房卡片显示：
   - 跳纤总数
   - 在用数量（绿色标识）
   - 已拆除数量（红色标识）
   - 状态占比进度条

#### 8.6.2 筛选跳纤统计
1. 在跳纤统计页使用筛选条件
2. 选择机房名称（全部/特定机房）
3. 选择线路状态（全部/在用/已拆除）
4. 系统自动刷新显示符合条件的统计卡片

#### 8.6.3 查看机房跳纤详情
1. 在统计卡片上点击"查看详情"按钮
2. 跳转到该机房的跳纤详情页
3. 查看该机房的详细跳纤记录列表
4. 可按状态筛选跳纤记录
5. 点击记录查看详情
6. 点击"返回统计"返回跳纤统计页

#### 8.6.4 导出跳纤统计报表
1. 在跳纤统计页设置筛选条件（可选）
2. 点击"导出统计报表"按钮
3. 系统生成Excel文件
4. 浏览器自动下载Excel文件
5. Excel文件包含各机房的统计信息

### 8.7 重复记录处理功能（US-005）

#### 8.7.1 重复记录识别规则
系统按以下优先级识别重复记录：
1. **优先级1**: 任务单需求编号（IDC需求编号）
2. **优先级2**: YES工单编号
3. **优先级3**: 链路编号（线路编号）
4. **优先级4**: 登记表编号
5. **优先级5**: 组合键 - 机房名称 + 线路编号
6. **优先级6**: 组合键 - 机房名称 + 用户单位 + 线路编号

#### 8.7.2 上传时的重复处理
1. 上传Excel文件后，系统自动检测重复记录
2. 发现重复时，用新数据替换旧数据（UPDATE操作）
3. 非重复记录正常插入数据库（INSERT操作）
4. 上传完成后显示处理统计：
   - 新增记录数
   - 更新记录数
   - 失败记录数
   - 重复记录列表

#### 8.7.3 数据完整性保证
- 更新时保留原有记录的创建时间（created_at）
- 更新记录的最后修改时间（updated_at）
- 所有操作记录到operation_logs表
- 支持数据版本追溯

---

## 9. 常见问题

### 8.1 部署相关问题

#### Q1: Docker安装失败
**问题描述**: 执行Docker安装脚本时出错。

**解决方案**:
```bash
# 检查系统版本
cat /etc/os-release

# 使用适合系统的安装方法
# Ubuntu/Debian
sudo apt-get install -y docker.io

# CentOS/RHEL
sudo yum install -y docker
```

#### Q2: 端口被占用
**问题描述**: 启动服务时提示端口已被占用。

**解决方案**:
```bash
# 查看端口占用情况
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :3001

# 停止占用端口的进程
sudo kill -9 <PID>

# 或者修改docker-compose.yml中的端口映射
```

#### Q3: 容器启动失败
**问题描述**: 容器启动后立即退出。

**解决方案**:
```bash
# 查看容器日志
docker-compose logs backend
docker-compose logs frontend

# 检查配置文件
cat config/docker-compose.yml

# 重新构建镜像
docker-compose build --no-cache
docker-compose up -d
```

### 8.2 运行时问题

#### Q4: 无法访问前端页面
**问题描述**: 浏览器无法打开系统页面。

**解决方案**:
```bash
# 检查容器状态
docker-compose ps

# 检查防火墙设置
sudo ufw status
sudo ufw allow 80/tcp

# 检查Nginx日志
docker-compose logs frontend
```

#### Q5: 上传文件失败
**问题描述**: 上传Excel文件时提示"上传失败"。

**解决方案**:
```bash
# 检查上传目录权限
ls -la backend/uploads/

# 检查后端日志
docker-compose logs backend

# 检查文件大小限制
# 确保文件不超过50MB
```

#### Q6: 查询结果为空
**问题描述**: 查询布线记录时没有返回结果。

**解决方案**:
```bash
# 检查数据库文件
ls -la backend/data/

# 检查数据库内容
docker exec -it wiring-backend sqlite3 /app/data/wiring.db "SELECT COUNT(*) FROM records;"

# 检查查询条件是否正确
```

### 8.3 性能问题

#### Q7: 系统响应缓慢
**问题描述**: 页面加载或查询响应时间过长。

**解决方案**:
```bash
# 检查系统资源使用情况
docker stats

# 检查数据库性能
docker exec -it wiring-backend sqlite3 /app/data/wiring.db "PRAGMA integrity_check;"

# 优化数据库
docker exec -it wiring-backend sqlite3 /app/data/wiring.db "VACUUM;"
```

#### Q8: 内存占用过高
**问题描述**: 容器内存占用持续增长。

**解决方案**:
```bash
# 限制容器内存使用
# 编辑docker-compose.yml，添加资源限制
deploy:
  resources:
    limits:
      memory: 512M

# 重启服务
docker-compose restart
```

---

## 9. 系统维护

### 9.1 日常维护

#### 9.1.1 查看服务状态
```bash
cd /opt/sjzx-zonghebuxian/config
docker-compose ps
```

#### 9.1.2 查看日志
```bash
# 查看所有日志
docker-compose logs -f

# 查看最近100行日志
docker-compose logs --tail=100

# 查看特定时间段的日志
docker-compose logs --since 2025-01-01T00:00:00
```

#### 9.1.3 清理日志
```bash
# 清理Docker日志
docker system prune -a

# 清理特定容器的日志
truncate -s 0 /var/lib/docker/containers/<container_id>/<container_id>-json.log
```

### 9.2 数据备份

#### 9.2.1 手动备份
```bash
# 备份数据库
docker exec wiring-backend cp /app/data/wiring.db /backup/wiring_$(date +%Y%m%d).db

# 备份上传文件
docker exec wiring-backend tar -czf /tmp/uploads_$(date +%Y%m%d).tar.gz -C /app uploads
docker cp wiring-backend:/tmp/uploads_$(date +%Y%m%d).tar.gz /backup/
```

#### 9.2.2 自动备份
创建定时任务：
```bash
# 编辑crontab
crontab -e

# 添加每日凌晨2点备份
0 2 * * * /opt/sjzx-zonghebuxian/scripts/backup.sh
```

#### 9.2.3 数据恢复
```bash
# 停止服务
docker-compose down

# 恢复数据库
cp /backup/wiring_20250104.db backend/data/wiring.db

# 恢复上传文件
tar -xzf /backup/uploads_20250104.tar.gz -C backend/

# 重启服务
docker-compose up -d
```

### 9.3 系统更新

#### 9.3.1 更新代码
```bash
# 拉取最新代码
cd /opt/sjzx-zonghebuxian
git pull origin main

# 重新构建镜像
cd config
docker-compose build

# 重启服务
docker-compose up -d
```

#### 9.3.2 回滚版本
```bash
# 查看提交历史
git log --oneline

# 回滚到指定版本
git checkout <commit-hash>

# 重新构建和启动
cd config
docker-compose build
docker-compose up -d
```

### 9.4 性能优化

#### 9.4.1 数据库优化
```bash
# 进入数据库
docker exec -it wiring-backend sqlite3 /app/data/wiring.db

# 创建索引
CREATE INDEX IF NOT EXISTS idx_user_unit ON records(user_unit);
CREATE INDEX IF NOT EXISTS idx_building ON records(building);
CREATE INDEX IF NOT EXISTS idx_floor ON records(floor);

# 优化数据库
VACUUM;
ANALYZE;
```

#### 9.4.2 容器优化
```bash
# 清理未使用的镜像
docker image prune -a

# 清理未使用的容器
docker container prune

# 清理未使用的卷
docker volume prune
```

---

## 10. 技术支持

### 10.1 联系方式
- **技术文档**: 参考项目根目录的部署文档
- **问题反馈**: 提交GitHub Issue
- **紧急联系**: 系统管理员

### 10.2 相关文档
- [服务器使用说明](file:///d:\TREA\sjzx-zonghebuxian\deploy_服务器使用说明.md)
- [部署技术细节](file:///d:\TREA\sjzx-zonghebuxian\deploy_部署技术细节.md)
- [自动部署脚本](file:///d:\TREA\sjzx-zonghebuxian\deploy_自动部署.sh)

### 10.3 参考资源
- [Docker官方文档](https://docs.docker.com/)
- [Docker Compose官方文档](https://docs.docker.com/compose/)
- [Vue.js官方文档](https://vuejs.org/)
- [Node.js官方文档](https://nodejs.org/)

---

## 附录

### A. Docker命令速查
```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 查看日志
docker-compose logs -f

# 进入容器
docker exec -it <container_name> sh

# 更新镜像
docker-compose pull
docker-compose up -d
```

### B. 数据库管理命令
```bash
# 进入数据库
docker exec -it wiring-backend sqlite3 /app/data/wiring.db

# 查看表结构
.schema

# 查询数据
SELECT * FROM records LIMIT 10;

# 统计记录数
SELECT COUNT(*) FROM records;

# 导出数据
.mode csv
.output records.csv
SELECT * FROM records;
.quit
```

### C. 系统监控命令
```bash
# 查看容器资源使用
docker stats

# 查看磁盘使用
df -h

# 查看内存使用
free -h

# 查看CPU使用
top
```

---

**文档结束**
