# 远程部署快速指南

## 📋 前提条件

在开始部署之前，请确保：

1. ✅ **网络连接**：本地电脑可以访问服务器 IP: 192.168.19.58
2. ✅ **SSH密钥配置**：已配置SSH密钥认证（推荐）
3. ✅ **服务器访问**：可以SSH登录到服务器（用户名：yroot）
4. ✅ **PowerShell**：本地电脑已安装PowerShell 5.0或更高版本

---

## 🚀 部署步骤

### 步骤1：测试SSH连接（推荐）

在部署之前，先测试SSH连接是否正常：

```powershell
cd "d:\TREA\sjzx-zonghebuxian\部署脚本_"
.\test_ssh_connection.bat
```

或者直接运行PowerShell脚本：

```powershell
.\test_ssh_connection.ps1
```

**如果测试失败：**
- 运行 `setup_ssh_key.ps1` 配置SSH密钥
- 检查网络连接：`ping 192.168.19.58`
- 确认SSH服务在服务器上运行

---

### 步骤2：运行部署脚本

#### 方法1：使用批处理文件（最简单）

```powershell
.\远程部署.bat
```

#### 方法2：使用PowerShell启动脚本（推荐）

```powershell
.\启动远程部署.ps1
```

#### 方法3：直接运行PowerShell部署脚本

```powershell
.\远程部署_自动.ps1
```

---

## 📝 部署流程

部署脚本会自动完成以下步骤：

1. **测试SSH连接** - 验证与服务器的连接
2. **获取系统信息** - 检测服务器操作系统
3. **检查Node.js** - 验证Node.js版本，必要时安装Node.js 18
4. **复制文件** - 将本地代码复制到服务器
5. **安装依赖** - 安装后端和前端依赖包
6. **构建前端** - 编译前端代码
7. **启动服务** - 启动后端和前端服务
8. **验证服务** - 确认服务正常运行

**预计时间：** 20-40分钟（取决于网络速度和服务器性能）

---

## 🔧 部署后验证

部署完成后，可以通过以下URL访问应用：

- **前端**: http://192.168.19.58:80
- **后端**: http://192.168.19.58:3001

---

## 📊 查看日志

### 查看后端日志

```powershell
ssh yroot@192.168.19.58 'tail -f ~/sjzx-zonghebuxian/backend/backend.log'
```

### 查看前端日志

```powershell
ssh yroot@192.168.19.58 'tail -f ~/sjzx-zonghebuxian/frontend/frontend.log'
```

---

## 🛑 停止服务

如果需要停止所有服务：

```powershell
ssh yroot@192.168.19.58 'pkill -f node'
```

或者分别停止：

```powershell
# 停止后端
ssh yroot@192.168.19.58 'pkill -f "node.*backend/server.js"'

# 停止前端
ssh yroot@192.168.19.58 'pkill -f "npm.*preview"'
```

---

## 🔄 重新部署

如果需要重新部署：

1. **停止服务**（可选，脚本会自动停止）
   ```powershell
   ssh yroot@192.168.19.58 'pkill -f node'
   ```

2. **运行部署脚本**
   ```powershell
   .\远程部署.bat
   ```

脚本会自动：
- 停止正在运行的服务
- 复制最新代码
- 重新安装依赖
- 重新构建前端
- 启动服务

---

## ⚠️ 常见问题

### 问题1：SSH连接失败

**错误信息：**
```
Connection refused
Permission denied
```

**解决方案：**
1. 运行 `setup_ssh_key.ps1` 配置SSH密钥
2. 检查服务器IP是否正确：192.168.19.58
3. 确认SSH服务在服务器上运行：
   ```powershell
   ssh yroot@192.168.19.58 'sudo systemctl status sshd'
   ```

---

### 问题2：文件复制失败

**错误信息：**
```
Failed to copy backend files
Permission denied
```

**解决方案：**
1. 确保SSH密钥已正确配置
2. 检查服务器磁盘空间：
   ```powershell
   ssh yroot@192.168.19.58 'df -h'
   ```
3. 检查服务器目录权限：
   ```powershell
   ssh yroot@192.168.19.58 'ls -la ~/sjzx-zonghebuxian'
   ```

---

### 问题3：Node.js安装失败

**错误信息：**
```
Failed to install Node.js
```

**解决方案：**
1. 手动安装Node.js 18：
   ```bash
   # Ubuntu/Debian
   curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
   sudo apt-get install -y nodejs

   # CentOS/RHEL
   curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
   sudo yum install -y nodejs
   ```

2. 验证安装：
   ```powershell
   ssh yroot@192.168.19.58 'node --version'
   ```

---

### 问题4：依赖安装失败

**错误信息：**
```
Failed to install backend dependencies
```

**解决方案：**
1. 检查网络连接（服务器需要访问npm仓库）
2. 清理npm缓存：
   ```powershell
   ssh yroot@192.168.19.58 'cd ~/sjzx-zonghebuxian/backend && npm cache clean --force'
   ```
3. 重新运行部署脚本

---

### 问题5：服务启动失败

**错误信息：**
```
Failed to start backend service
```

**解决方案：**
1. 查看日志文件：
   ```powershell
   ssh yroot@192.168.19.58 'cat ~/sjzx-zonghebuxian/backend/backend.log'
   ```

2. 检查端口是否被占用：
   ```powershell
   ssh yroot@192.168.19.58 'netstat -tuln | grep -E ":(80|3001)"'
   ```

3. 手动启动服务进行测试：
   ```powershell
   ssh yroot@192.168.19.58 'cd ~/sjzx-zonghebuxian/backend && npm start'
   ```

---

## 📚 相关文档

- [SSH密钥设置指南](SSH密钥设置指南.md)
- [远程服务器部署完整指南](远程服务器部署完整指南.md)
- [部署指南](部署指南.md)

---

## 💡 提示

1. **首次部署**：建议先运行 `test_ssh_connection.bat` 测试连接
2. **定期部署**：可以直接运行 `远程部署.bat` 进行更新
3. **监控日志**：部署完成后，定期查看日志确保服务正常运行
4. **备份**：重要数据请定期备份

---

## 🆘 获取帮助

如果遇到问题：

1. 查看错误信息
2. 检查日志文件
3. 参考常见问题部分
4. 查看相关文档

---

## 📞 技术支持

如有技术问题，请联系系统管理员。

---

**祝部署顺利！** 🎉
