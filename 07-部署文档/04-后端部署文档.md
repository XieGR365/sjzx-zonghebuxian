# 后端部署文档

## 1. 后端概述

### 1.1 技术栈
- **框架**: Express.js
- **语言**: TypeScript
- **数据库**: SQLite (better-sqlite3)
- **文件上传**: Multer
- **Excel解析**: xlsx

### 1.2 部署目标
- 将TypeScript代码编译为JavaScript
- 部署为Windows服务
- 配置日志和监控
- 设置数据备份

## 2. 准备工作

### 2.1 确认源码位置
确保后端源码位于:
```
d:\TREA\sjzx-zonghebuxian\04-实施\后端\
```

### 2.2 检查依赖文件
确认以下文件存在:
- package.json
- tsconfig.json
- src/server.ts

## 3. 构建后端应用

### 3.1 安装依赖
```powershell
cd d:\TREA\sjzx-zonghebuxian\04-实施\后端
npm install --production
```

### 3.2 配置生产环境

#### 3.2.1 创建.env文件
创建 `.env` 文件:

```env
NODE_ENV=production
PORT=3001
DATABASE_PATH=D:\wiring-record-system\backend\database\wiring-record.db
UPLOAD_PATH=D:\wiring-record-system\backend\uploads
LOG_PATH=D:\wiring-record-system\backend\logs
CORS_ORIGIN=*
MAX_FILE_SIZE=52428800
```

#### 3.2.2 修改数据库路径
编辑 `src\config\database.ts`，确保数据库路径正确:

```typescript
const DB_PATH = process.env.DATABASE_PATH || path.join(__dirname, '../../database/wiring-record.db');
```

### 3.3 执行编译
```powershell
npm run build
```

编译成功后，会在 `dist` 目录生成JavaScript文件。

### 3.4 验证编译结果
```powershell
Get-ChildItem -Path "dist" -Recurse
```

## 4. 部署到生产环境

### 4.1 复制构建文件
```powershell
# 创建目标目录
New-Item -ItemType Directory -Path "D:\wiring-record-system\backend\dist" -Force

# 复制编译后的文件
Copy-Item -Path "d:\TREA\sjzx-zonghebuxian\04-实施\后端\dist\*" -Destination "D:\wiring-record-system\backend\dist\" -Recurse -Force

# 复制配置文件
Copy-Item -Path "d:\TREA\sjzx-zonghebuxian\04-实施\后端\.env" -Destination "D:\wiring-record-system\backend\" -Force

# 复制package.json
Copy-Item -Path "d:\TREA\sjzx-zonghebuxian\04-实施\后端\package.json" -Destination "D:\wiring-record-system\backend\" -Force
```

### 4.2 安装生产依赖
```powershell
cd D:\wiring-record-system\backend
npm install --production
```

### 4.3 初始化数据库
```powershell
cd D:\wiring-record-system\backend
node dist/scripts/initDb.js
```

### 4.4 验证数据库
```powershell
Get-ChildItem -Path "D:\wiring-record-system\backend\database"
```

预期输出:
```
    目录: D:\wiring-record-system\backend\database

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a---          2025/12/30    10:00        123456 wiring-record.db
```

## 5. 配置Windows服务

### 5.1 下载WinSW
1. 访问: https://github.com/winsw/winsw/releases
2. 下载最新版本的WinSW.exe
3. 重命名为 `wiring-record-service.exe`
4. 放到 `D:\wiring-record-system\backend\` 目录

### 5.2 创建WinSW配置文件
创建 `wiring-record-service.xml` 文件:

```xml
<service>
  <id>wiring-record-backend</id>
  <name>综合布线记录管理系统 - 后端服务</name>
  <description>综合布线记录管理系统后端API服务</description>
  <executable>node.exe</executable>
  <arguments>dist/server.js</arguments>
  <logpath>logs</logpath>
  <log mode="roll-by-size">
    <sizeThreshold>10240</sizeThreshold>
    <keepFiles>8</keepFiles>
  </log>
  <onfailure action="restart" delay="10 sec"/>
  <onfailure action="restart" delay="20 sec"/>
  <onfailure action="restart" delay="30 sec"/>
  <env name="NODE_ENV" value="production"/>
  <env name="PORT" value="3001"/>
  <env name="DATABASE_PATH" value="D:\wiring-record-system\backend\database\wiring-record.db"/>
  <env name="UPLOAD_PATH" value="D:\wiring-record-system\backend\uploads"/>
  <env name="LOG_PATH" value="D:\wiring-record-system\backend\logs"/>
</service>
```

### 5.3 安装Windows服务
```powershell
cd D:\wiring-record-system\backend
.\wiring-record-service.exe install
```

### 5.4 启动服务
```powershell
# 启动服务
Start-Service -Name "wiring-record-backend"

# 检查服务状态
Get-Service -Name "wiring-record-backend"
```

预期输出:
```
Status  Name               DisplayName
------  ----               -----------
Running wiring-record-ba... 综合布线记录管理系统 - 后端服务
```

## 6. 配置PM2 (可选)

### 6.1 安装PM2
```powershell
npm install -g pm2
npm install -g pm2-windows-startup
pm2-startup install
```

### 6.2 创建PM2配置文件
创建 `ecosystem.config.js` 文件:

```javascript
module.exports = {
  apps: [{
    name: 'wiring-record-backend',
    script: 'dist/server.js',
    cwd: 'D:\\wiring-record-system\\backend',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: 'logs/pm2-error.log',
    out_file: 'logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'
  }]
};
```

### 6.3 启动PM2
```powershell
cd D:\wiring-record-system\backend
pm2 start ecosystem.config.js
pm2 save
```

### 6.4 查看PM2状态
```powershell
pm2 status
pm2 logs
```

## 7. 验证部署

### 7.1 检查服务运行状态
```powershell
Get-Service -Name "wiring-record-backend"
```

### 7.2 测试API接口
```powershell
# 测试健康检查接口
Invoke-RestMethod -Uri "http://localhost:3001/api/health" -Method GET

# 测试获取记录列表
Invoke-RestMethod -Uri "http://localhost:3001/api/records" -Method GET
```

### 7.3 检查日志
```powershell
# 查看应用日志
Get-Content -Path "D:\wiring-record-system\backend\logs\app.log" -Tail 50

# 查看错误日志
Get-Content -Path "D:\wiring-record-system\backend\logs\error.log" -Tail 50
```

## 8. 配置防火墙

### 8.1 开放后端端口 (仅内部访问)
```powershell
# 如果需要从外部访问后端API，开放3001端口
New-NetFirewallRule -DisplayName "Wiring Record Backend" -Direction Inbound -LocalPort 3001 -Protocol TCP -Action Allow
```

**注意**: 生产环境中，后端API应该只通过IIS反向代理访问，不直接暴露3001端口。

## 9. 配置日志管理

### 9.1 配置日志轮转
在 `src\config\logger.ts` 中配置日志轮转:

```typescript
import winston from 'winston';
import 'winston-daily-rotate-file';

const transport = new winston.transports.DailyRotateFile({
  filename: 'logs/app-%DATE%.log',
  datePattern: 'YYYY-MM-DD',
  zippedArchive: true,
  maxSize: '20m',
  maxFiles: '30d'
});

const logger = winston.createLogger({
  transports: [transport]
});
```

### 9.2 创建日志清理脚本
创建 `clean-logs.ps1`:

```powershell
$logsPath = "D:\wiring-record-system\backend\logs"
$daysToKeep = 30

Get-ChildItem -Path $logsPath -Filter "*.log" | Where-Object {
    $_.LastWriteTime -lt (Get-Date).AddDays(-$daysToKeep)
} | Remove-Item -Force

Write-Host "日志清理完成，保留最近 $daysToKeep 天的日志" -ForegroundColor Green
```

### 9.3 设置定时清理任务
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-File D:\wiring-record-system\backend\clean-logs.ps1"
$trigger = New-ScheduledTaskTrigger -Daily -At "02:00"
Register-ScheduledTask -TaskName "Clean Backend Logs" -Action $action -Trigger $trigger -RunLevel Highest
```

## 10. 性能优化

### 10.1 配置连接池
在 `src\config\database.ts` 中配置连接池:

```typescript
const db = new Database(DB_PATH, {
  verbose: process.env.NODE_ENV === 'development' ? console.log : null
});

db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
db.pragma('cache_size = -64000');
db.pragma('temp_store = MEMORY');
```

### 10.2 配置Express中间件
在 `src\server.ts` 中配置中间件:

```typescript
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(compression());
```

### 10.3 启用Gzip压缩
```powershell
npm install compression
```

## 11. 故障排查

### 11.1 服务无法启动
**问题**: Windows服务无法启动

**解决方案**:
1. 检查Node.js路径是否在系统PATH中
2. 检查配置文件是否正确
3. 查看Windows事件日志
4. 检查端口是否被占用

### 11.2 数据库连接失败
**问题**: 无法连接到SQLite数据库

**解决方案**:
1. 检查数据库文件路径是否正确
2. 检查文件权限
3. 检查数据库文件是否损坏

### 11.3 文件上传失败
**问题**: 文件上传时出现错误

**解决方案**:
1. 检查uploads目录权限
2. 检查文件大小限制
3. 检查磁盘空间

### 11.4 API响应慢
**问题**: API接口响应时间过长

**解决方案**:
1. 检查数据库查询性能
2. 添加索引
3. 启用查询缓存
4. 优化Excel解析逻辑

## 12. 更新部署

### 12.1 更新流程
1. 停止服务:
```powershell
Stop-Service -Name "wiring-record-backend"
```

2. 备份当前版本:
```powershell
Copy-Item -Path "D:\wiring-record-system\backend" -Destination "D:\wiring-record-system\backup\backend_$(Get-Date -Format 'yyyyMMdd_HHmmss')" -Recurse
```

3. 编译新版本:
```powershell
cd d:\TREA\sjzx-zonghebuxian\04-实施\后端
npm run build
```

4. 部署新版本:
```powershell
Copy-Item -Path "dist\*" -Destination "D:\wiring-record-system\backend\dist\" -Recurse -Force
```

5. 启动服务:
```powershell
Start-Service -Name "wiring-record-backend"
```

6. 验证新版本

### 12.2 数据库迁移
如果数据库结构有变化，需要执行迁移:

```powershell
cd D:\wiring-record-system\backend
node dist/scripts/migrate.js
```

## 13. 监控与告警

### 13.1 创建健康检查脚本
创建 `health-check.ps1`:

```powershell
try {
    $response = Invoke-RestMethod -Uri "http://localhost:3001/api/health" -Method GET -TimeoutSec 5
    Write-Host "服务状态: 正常" -ForegroundColor Green
    Write-Host "响应时间: $($response.responseTime)ms" -ForegroundColor Cyan
} catch {
    Write-Host "服务状态: 异常" -ForegroundColor Red
    Write-Host "错误信息: $_" -ForegroundColor Red
    
    # 发送告警邮件
    Send-MailMessage -From "monitoring@company.com" -To "admin@company.com" -Subject "后端服务异常" -Body "后端服务健康检查失败: $_" -SmtpServer "smtp.company.com"
}
```

### 13.2 设置定时健康检查
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-File D:\wiring-record-system\backend\health-check.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 5)
Register-ScheduledTask -TaskName "Backend Health Check" -Action $action -Trigger $trigger -RunLevel Highest
```

## 14. 下一步

后端部署完成后，请继续阅读:
- [04-HTTPS配置文档.md](./04-HTTPS配置文档.md)
- [05-数据备份方案文档.md](./05-数据备份方案文档.md)

---

**文档版本**: v1.0
**创建日期**: 2025-12-30
**最后更新**: 2025-12-30
**维护人员**: 综合布线记录管理系统团队
