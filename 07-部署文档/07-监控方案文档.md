# 监控方案文档

## 1. 监控概述

### 1.1 监控目标
- 系统可用性监控
- 性能指标监控
- 资源使用监控
- 日志监控
- 故障告警

### 1.2 监控范围
- **服务器监控**: CPU、内存、磁盘、网络
- **应用监控**: 进程状态、响应时间、错误率
- **数据库监控**: 查询性能、连接数、文件大小
- **日志监控**: 错误日志、访问日志、系统日志

### 1.3 监控工具
- **Windows Performance Monitor**: 系统性能监控
- **Event Viewer**: 系统事件监控
- **自定义脚本**: 应用健康检查
- **日志分析**: 日志文件监控

## 2. 系统监控

### 2.1 CPU监控
监控CPU使用率，确保系统性能正常。

### 2.1.1 创建CPU监控脚本
创建 `D:\wiring-record-system\monitoring\scripts\monitor-cpu.ps1`:

```powershell
# CPU监控脚本
$logPath = "D:\wiring-record-system\monitoring\logs\cpu-monitor.log"
$alertThreshold = 80  # CPU使用率告警阈值
$alertEmail = "admin@company.com"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    # 获取CPU使用率
    $cpuUsage = (Get-Counter '\Processor(_Total)\% Processor Time' -SampleInterval 1 -MaxSamples 1).CounterSamples.CookedValue
    $cpuUsageRounded = [math]::Round($cpuUsage, 2)
    
    Write-Log "CPU使用率: $cpuUsageRounded%"
    
    # 检查是否超过阈值
    if ($cpuUsageRounded -gt $alertThreshold) {
        Write-Log "警告: CPU使用率超过阈值 ($alertThreshold%)" -ForegroundColor Red
        
        # 发送告警邮件
        try {
            $subject = "CPU使用率告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            $body = @"
服务器CPU使用率告警

服务器名称: $env:COMPUTERNAME
CPU使用率: $cpuUsageRounded%
告警阈值: $alertThreshold%
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

请及时检查系统状态。
"@
            Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
            Write-Log "告警邮件已发送"
        } catch {
            Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
        }
    }
    
} catch {
    Write-Log "CPU监控失败: $_" -ForegroundColor Red
    exit 1
}
```

### 2.2 内存监控
监控内存使用情况，防止内存溢出。

### 2.2.1 创建内存监控脚本
创建 `D:\wiring-record-system\monitoring\scripts\monitor-memory.ps1`:

```powershell
# 内存监控脚本
$logPath = "D:\wiring-record-system\monitoring\logs\memory-monitor.log"
$alertThreshold = 85  # 内存使用率告警阈值
$alertEmail = "admin@company.com"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    # 获取内存使用情况
    $totalMemory = (Get-CimInstance Win32_ComputerSystem).TotalPhysicalMemory / 1GB
    $freeMemory = (Get-CimInstance Win32_OperatingSystem).FreePhysicalMemory / 1MB
    $usedMemory = $totalMemory - ($freeMemory / 1024)
    $memoryUsage = ($usedMemory / $totalMemory) * 100
    $memoryUsageRounded = [math]::Round($memoryUsage, 2)
    
    Write-Log "内存使用率: $memoryUsageRounded% (已使用: $([math]::Round($usedMemory, 2)) GB / 总计: $([math]::Round($totalMemory, 2)) GB)"
    
    # 检查是否超过阈值
    if ($memoryUsageRounded -gt $alertThreshold) {
        Write-Log "警告: 内存使用率超过阈值 ($alertThreshold%)" -ForegroundColor Red
        
        # 发送告警邮件
        try {
            $subject = "内存使用率告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            $body = @"
服务器内存使用率告警

服务器名称: $env:COMPUTERNAME
内存使用率: $memoryUsageRounded%
已使用内存: $([math]::Round($usedMemory, 2)) GB
总内存: $([math]::Round($totalMemory, 2)) GB
告警阈值: $alertThreshold%
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

请及时检查系统状态。
"@
            Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
            Write-Log "告警邮件已发送"
        } catch {
            Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
        }
    }
    
} catch {
    Write-Log "内存监控失败: $_" -ForegroundColor Red
    exit 1
}
```

### 2.3 磁盘监控
监控磁盘使用情况，防止磁盘空间不足。

### 2.3.1 创建磁盘监控脚本
创建 `D:\wiring-record-system\monitoring\scripts\monitor-disk.ps1`:

```powershell
# 磁盘监控脚本
$logPath = "D:\wiring-record-system\monitoring\logs\disk-monitor.log"
$alertThreshold = 80  # 磁盘使用率告警阈值
$alertEmail = "admin@company.com"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    # 获取所有磁盘
    $disks = Get-PSDrive -PSProvider FileSystem
    
    foreach ($disk in $disks) {
        $totalSpace = $disk.Used + $disk.Free
        $usedSpace = $disk.Used
        $freeSpace = $disk.Free
        $diskUsage = ($usedSpace / $totalSpace) * 100
        $diskUsageRounded = [math]::Round($diskUsage, 2)
        
        $totalSpaceGB = [math]::Round($totalSpace / 1GB, 2)
        $usedSpaceGB = [math]::Round($usedSpace / 1GB, 2)
        $freeSpaceGB = [math]::Round($freeSpace / 1GB, 2)
        
        Write-Log "磁盘 $($disk.Name): 使用率 $diskUsageRounded% (已使用: $usedSpaceGB GB / 总计: $totalSpaceGB GB / 可用: $freeSpaceGB GB)"
        
        # 检查是否超过阈值
        if ($diskUsageRounded -gt $alertThreshold) {
            Write-Log "警告: 磁盘 $($disk.Name) 使用率超过阈值 ($alertThreshold%)" -ForegroundColor Red
            
            # 发送告警邮件
            try {
                $subject = "磁盘使用率告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                $body = @"
服务器磁盘使用率告警

服务器名称: $env:COMPUTERNAME
磁盘: $($disk.Name):\
磁盘使用率: $diskUsageRounded%
已使用空间: $usedSpaceGB GB
总空间: $totalSpaceGB GB
可用空间: $freeSpaceGB GB
告警阈值: $alertThreshold%
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

请及时清理磁盘空间或扩容。
"@
                Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
                Write-Log "告警邮件已发送"
            } catch {
                Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
            }
        }
    }
    
} catch {
    Write-Log "磁盘监控失败: $_" -ForegroundColor Red
    exit 1
}
```

## 3. 应用监控

### 3.1 进程监控
监控后端服务进程状态。

### 3.1.1 创建进程监控脚本
创建 `D:\wiring-record-system\monitoring\scripts\monitor-process.ps1`:

```powershell
# 进程监控脚本
$logPath = "D:\wiring-record-system\monitoring\logs\process-monitor.log"
$serviceName = "wiring-record-backend"
$alertEmail = "admin@company.com"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    # 检查服务状态
    $service = Get-Service -Name $serviceName -ErrorAction SilentlyContinue
    
    if ($service) {
        Write-Log "服务状态: $($service.Status)"
        
        if ($service.Status -ne "Running") {
            Write-Log "警告: 服务未运行，尝试启动服务" -ForegroundColor Red
            
            # 尝试启动服务
            try {
                Start-Service -Name $serviceName -ErrorAction Stop
                Start-Sleep -Seconds 5
                
                $service = Get-Service -Name $serviceName
                if ($service.Status -eq "Running") {
                    Write-Log "服务启动成功" -ForegroundColor Green
                } else {
                    Write-Log "服务启动失败" -ForegroundColor Red
                    
                    # 发送告警邮件
                    try {
                        $subject = "服务异常告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                        $body = @"
服务器服务异常告警

服务器名称: $env:COMPUTERNAME
服务名称: $serviceName
服务状态: $($service.Status)
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

服务未正常运行，请及时检查。
"@
                        Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
                        Write-Log "告警邮件已发送"
                    } catch {
                        Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
                    }
                }
            } catch {
                Write-Log "启动服务失败: $_" -ForegroundColor Red
                
                # 发送告警邮件
                try {
                    $subject = "服务异常告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                    $body = @"
服务器服务异常告警

服务器名称: $env:COMPUTERNAME
服务名称: $serviceName
错误信息: $_
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

服务启动失败，请及时检查。
"@
                    Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
                    Write-Log "告警邮件已发送"
                } catch {
                    Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
                }
            }
        }
    } else {
        Write-Log "错误: 服务不存在" -ForegroundColor Red
        
        # 发送告警邮件
        try {
            $subject = "服务不存在告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            $body = @"
服务器服务不存在告警

服务器名称: $env:COMPUTERNAME
服务名称: $serviceName
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

服务不存在，请及时检查。
"@
            Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
            Write-Log "告警邮件已发送"
        } catch {
            Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
        }
    }
    
} catch {
    Write-Log "进程监控失败: $_" -ForegroundColor Red
    exit 1
}
```

### 3.2 健康检查
监控应用健康状态和API响应。

### 3.2.1 创建健康检查脚本
创建 `D:\wiring-record-system\monitoring\scripts\health-check.ps1`:

```powershell
# 健康检查脚本
$logPath = "D:\wiring-record-system\monitoring\logs\health-check.log"
$healthUrl = "http://localhost:3001/api/health"
$alertEmail = "admin@company.com"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    # 执行健康检查
    $startTime = Get-Date
    $response = Invoke-WebRequest -Uri $healthUrl -Method GET -TimeoutSec 10 -UseBasicParsing
    $endTime = Get-Date
    $responseTime = ($endTime - $startTime).TotalMilliseconds
    
    Write-Log "健康检查: HTTP $($response.StatusCode) - 响应时间: $([math]::Round($responseTime, 2)) ms"
    
    # 检查响应状态
    if ($response.StatusCode -ne 200) {
        Write-Log "警告: 健康检查失败，HTTP状态码: $($response.StatusCode)" -ForegroundColor Red
        
        # 发送告警邮件
        try {
            $subject = "健康检查失败告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            $body = @"
服务器健康检查失败告警

服务器名称: $env:COMPUTERNAME
健康检查URL: $healthUrl
HTTP状态码: $($response.StatusCode)
响应时间: $([math]::Round($responseTime, 2)) ms
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

健康检查失败，请及时检查应用状态。
"@
            Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
            Write-Log "告警邮件已发送"
        } catch {
            Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
        }
    }
    
} catch {
    Write-Log "健康检查失败: $_" -ForegroundColor Red
    
    # 发送告警邮件
    try {
        $subject = "健康检查失败告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        $body = @"
服务器健康检查失败告警

服务器名称: $env:COMPUTERNAME
健康检查URL: $healthUrl
错误信息: $_
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

健康检查失败，请及时检查应用状态。
"@
        Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
        Write-Log "告警邮件已发送"
    } catch {
        Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
    }
    
    exit 1
}
```

## 4. 数据库监控

### 4.1 数据库文件监控
监控数据库文件大小和增长情况。

### 4.1.1 创建数据库监控脚本
创建 `D:\wiring-record-system\monitoring\scripts\monitor-database.ps1`:

```powershell
# 数据库监控脚本
$logPath = "D:\wiring-record-system\monitoring\logs\database-monitor.log"
$dbPath = "D:\wiring-record-system\backend\database\wiring-record.db"
$alertEmail = "admin@company.com"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    # 检查数据库文件
    if (Test-Path $dbPath) {
        $dbFile = Get-Item $dbPath
        $dbSize = $dbFile.Length
        $dbSizeMB = [math]::Round($dbSize / 1MB, 2)
        $dbSizeGB = [math]::Round($dbSize / 1GB, 2)
        
        Write-Log "数据库文件大小: $dbSizeMB MB ($dbSizeGB GB)"
        
        # 检查数据库文件是否过大（超过1GB）
        if ($dbSizeGB -gt 1) {
            Write-Log "警告: 数据库文件超过1GB，建议进行优化" -ForegroundColor Yellow
            
            # 发送告警邮件
            try {
                $subject = "数据库文件过大告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                $body = @"
数据库文件过大告警

服务器名称: $env:COMPUTERNAME
数据库文件: $dbPath
文件大小: $dbSizeGB GB
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

数据库文件过大，建议进行优化或清理历史数据。
"@
                Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
                Write-Log "告警邮件已发送"
            } catch {
                Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
            }
        }
    } else {
        Write-Log "警告: 数据库文件不存在" -ForegroundColor Red
        
        # 发送告警邮件
        try {
            $subject = "数据库文件不存在告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            $body = @"
数据库文件不存在告警

服务器名称: $env:COMPUTERNAME
数据库文件: $dbPath
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

数据库文件不存在，请及时检查。
"@
            Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
            Write-Log "告警邮件已发送"
        } catch {
            Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
        }
    }
    
} catch {
    Write-Log "数据库监控失败: $_" -ForegroundColor Red
    exit 1
}
```

## 5. 日志监控

### 5.1 错误日志监控
监控应用错误日志，及时发现异常。

### 5.1.1 创建错误日志监控脚本
创建 `D:\wiring-record-system\monitoring\scripts\monitor-error-logs.ps1`:

```powershell
# 错误日志监控脚本
$logPath = "D:\wiring-record-system\monitoring\logs\error-log-monitor.log"
$backendLogPath = "D:\wiring-record-system\backend\logs"
$alertEmail = "admin@company.com"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    # 检查后端日志目录
    if (Test-Path $backendLogPath) {
        # 获取最近的错误日志
        $errorLogs = Get-ChildItem -Path $backendLogPath -Filter "*.log" | 
                     Sort-Object LastWriteTime -Descending | 
                     Select-Object -First 5
        
        foreach ($logFile in $errorLogs) {
            # 检查日志文件中的错误
            $errors = Select-String -Path $logFile.FullName -Pattern "error|Error|ERROR|exception|Exception|EXCEPTION" -CaseSensitive:$false
            
            if ($errors.Count -gt 0) {
                Write-Log "发现错误: $($logFile.Name) - 错误数量: $($errors.Count)" -ForegroundColor Yellow
                
                # 获取最近的错误（最近10个）
                $recentErrors = $errors | Select-Object -Last 10
                
                # 发送告警邮件
                try {
                    $subject = "应用错误日志告警 - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                    $errorDetails = $recentErrors | ForEach-Object { $_.Line } | Out-String
                    $body = @"
应用错误日志告警

服务器名称: $env:COMPUTERNAME
日志文件: $($logFile.FullName)
错误数量: $($errors.Count)
时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

最近的错误:
$errorDetails

请及时检查应用日志。
"@
                    Send-MailMessage -From "monitor@company.com" -To $alertEmail -Subject $subject -Body $body -SmtpServer "smtp.company.com"
                    Write-Log "告警邮件已发送"
                } catch {
                    Write-Log "发送告警邮件失败: $_" -ForegroundColor Red
                }
            } else {
                Write-Log "日志文件 $($logFile.Name) 无错误"
            }
        }
    } else {
        Write-Log "警告: 后端日志目录不存在" -ForegroundColor Yellow
    }
    
} catch {
    Write-Log "错误日志监控失败: $_" -ForegroundColor Red
    exit 1
}
```

## 6. 监控任务配置

### 6.1 创建监控目录
```powershell
# 创建监控目录结构
New-Item -ItemType Directory -Path "D:\wiring-record-system\monitoring\scripts" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\monitoring\logs" -Force
```

### 6.2 配置定时监控任务

#### 6.2.1 CPU监控任务（每5分钟）
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\monitoring\scripts\monitor-cpu.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 5) -RepetitionDuration ([TimeSpan]::MaxValue)
Register-ScheduledTask -TaskName "Monitor CPU" -Action $action -Trigger $trigger -RunLevel Highest -Description "CPU使用率监控（每5分钟）"
```

#### 6.2.2 内存监控任务（每5分钟）
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\monitoring\scripts\monitor-memory.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 5) -RepetitionDuration ([TimeSpan]::MaxValue)
Register-ScheduledTask -TaskName "Monitor Memory" -Action $action -Trigger $trigger -RunLevel Highest -Description "内存使用率监控（每5分钟）"
```

#### 6.2.3 磁盘监控任务（每10分钟）
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\monitoring\scripts\monitor-disk.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 10) -RepetitionDuration ([TimeSpan]::MaxValue)
Register-ScheduledTask -TaskName "Monitor Disk" -Action $action -Trigger $trigger -RunLevel Highest -Description "磁盘使用率监控（每10分钟）"
```

#### 6.2.4 进程监控任务（每1分钟）
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\monitoring\scripts\monitor-process.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 1) -RepetitionDuration ([TimeSpan]::MaxValue)
Register-ScheduledTask -TaskName "Monitor Process" -Action $action -Trigger $trigger -RunLevel Highest -Description "进程状态监控（每1分钟）"
```

#### 6.2.5 健康检查任务（每1分钟）
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\monitoring\scripts\health-check.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 1) -RepetitionDuration ([TimeSpan]::MaxValue)
Register-ScheduledTask -TaskName "Health Check" -Action $action -Trigger $trigger -RunLevel Highest -Description "应用健康检查（每1分钟）"
```

#### 6.2.6 数据库监控任务（每小时）
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\monitoring\scripts\monitor-database.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Hours 1) -RepetitionDuration ([TimeSpan]::MaxValue)
Register-ScheduledTask -TaskName "Monitor Database" -Action $action -Trigger $trigger -RunLevel Highest -Description "数据库监控（每小时）"
```

#### 6.2.7 错误日志监控任务（每10分钟）
```powershell
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\monitoring\scripts\monitor-error-logs.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 10) -RepetitionDuration ([TimeSpan]::MaxValue)
Register-ScheduledTask -TaskName "Monitor Error Logs" -Action $action -Trigger $trigger -RunLevel Highest -Description "错误日志监控（每10分钟）"
```

### 6.3 查看监控任务
```powershell
# 查看所有监控任务
Get-ScheduledTask | Where-Object { $_.TaskName -like "Monitor*" -or $_.TaskName -eq "Health Check" } | 
    Select-Object TaskName, State, LastRunTime, NextRunTime | 
    Format-Table -AutoSize
```

## 7. 监控报告

### 7.1 创建监控报告脚本
创建 `D:\wiring-record-system\monitoring\scripts\monitoring-report.ps1`:

```powershell
# 监控报告脚本
$reportPath = "D:\wiring-record-system\monitoring\logs\monitoring-report_$(Get-Date -Format 'yyyyMMdd').txt"

# 获取系统信息
$computerName = $env:COMPUTERNAME
$osInfo = Get-CimInstance Win32_OperatingSystem
$cpuInfo = Get-CimInstance Win32_Processor
$memoryInfo = Get-CimInstance Win32_ComputerSystem
$diskInfo = Get-PSDrive -PSProvider FileSystem

# 获取CPU使用率
$cpuUsage = (Get-Counter '\Processor(_Total)\% Processor Time' -SampleInterval 1 -MaxSamples 1).CounterSamples.CookedValue

# 获取内存使用情况
$totalMemory = $memoryInfo.TotalPhysicalMemory / 1GB
$freeMemory = $osInfo.FreePhysicalMemory / 1MB
$usedMemory = $totalMemory - ($freeMemory / 1024)
$memoryUsage = ($usedMemory / $totalMemory) * 100

# 获取服务状态
$service = Get-Service -Name "wiring-record-backend" -ErrorAction SilentlyContinue

# 生成报告
$report = @"
========================================
综合布线记录管理系统 - 监控报告
========================================
生成时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

1. 系统信息
----------------------------------------
服务器名称: $computerName
操作系统: $($osInfo.Caption)
操作系统版本: $($osInfo.Version)
CPU型号: $($cpuInfo.Name)
CPU核心数: $($cpuInfo.NumberOfCores)
总内存: $([math]::Round($totalMemory, 2)) GB

2. 性能指标
----------------------------------------
CPU使用率: $([math]::Round($cpuUsage, 2))%
内存使用率: $([math]::Round($memoryUsage, 2))%
已使用内存: $([math]::Round($usedMemory, 2)) GB
可用内存: $([math]::Round($freeMemory / 1024, 2)) GB

3. 磁盘使用情况
----------------------------------------
"@

foreach ($disk in $diskInfo) {
    $totalSpace = $disk.Used + $disk.Free
    $diskUsage = ($disk.Used / $totalSpace) * 100
    $report += "磁盘 $($disk.Name): 使用率 $([math]::Round($diskUsage, 2))% (已使用: $([math]::Round($disk.Used / 1GB, 2)) GB / 总计: $([math]::Round($totalSpace / 1GB, 2)) GB)`n"
}

$report += @"

4. 服务状态
----------------------------------------
"@

if ($service) {
    $report += "服务名称: $($service.Name)`n"
    $report += "服务状态: $($service.Status)`n"
    $report += "启动类型: $($service.StartType)`n"
    $report += "最后运行时间: $($service.LastRunTime)`n"
} else {
    $report += "服务不存在`n"
}

$report += @"

5. 数据库信息
----------------------------------------
数据库文件: D:\wiring-record-system\backend\database\wiring-record.db
"@

if (Test-Path "D:\wiring-record-system\backend\database\wiring-record.db") {
    $dbSize = (Get-Item "D:\wiring-record-system\backend\database\wiring-record.db").Length
    $report += "文件大小: $([math]::Round($dbSize / 1MB, 2)) MB`n"
} else {
    $report += "文件不存在`n"
}

$report += @"

========================================
"@

# 保存报告
$report | Out-File -FilePath $reportPath -Encoding UTF8

# 输出到控制台
Write-Host $report -ForegroundColor Cyan

# 发送邮件报告
try {
    Send-MailMessage -From "monitor@company.com" -To "admin@company.com" -Subject "监控报告 - $(Get-Date -Format 'yyyy-MM-dd')" -Body $report -SmtpServer "smtp.company.com"
    Write-Host "监控报告已发送到邮箱" -ForegroundColor Green
} catch {
    Write-Host "发送监控报告失败: $_" -ForegroundColor Red
}
```

### 7.2 配置定时报告任务
```powershell
# 创建每日报告任务（每天早上8点）
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\monitoring\scripts\monitoring-report.ps1"
$trigger = New-ScheduledTaskTrigger -Daily -At "08:00"
Register-ScheduledTask -TaskName "Monitoring Report" -Action $action -Trigger $trigger -RunLevel Highest -Description "每日监控报告任务"
```

## 8. 故障排查

### 8.1 监控任务未执行
**问题**: 定时监控任务没有执行

**解决方案**:
1. 检查任务计划程序服务是否运行
2. 检查任务是否启用
3. 检查任务执行历史
4. 检查脚本路径是否正确
5. 检查执行权限

### 8.2 告警邮件未发送
**问题**: 告警邮件没有发送

**解决方案**:
1. 检查SMTP服务器配置
2. 检查邮件地址是否正确
3. 检查网络连接
4. 检查防火墙设置
5. 查看监控日志

### 8.3 误报
**问题**: 收到误报告警

**解决方案**:
1. 调整告警阈值
2. 优化监控脚本
3. 增加告警确认机制
4. 排除正常波动

## 9. 下一步

监控方案配置完成后，请继续阅读:
- [07-运维手册.md](./07-运维手册.md)

---

**文档版本**: v1.0
**创建日期**: 2025-12-30
**最后更新**: 2025-12-30
**维护人员**: 综合布线记录管理系统团队
