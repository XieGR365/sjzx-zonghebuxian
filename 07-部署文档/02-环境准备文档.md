# 环境准备文档

## 1. 系统要求

### 1.1 硬件要求
- **CPU**: 2核及以上
- **内存**: 4GB及以上 (推荐8GB)
- **磁盘**: 20GB及以上可用空间
- **网络**: 公网IP或VPN访问能力

### 1.2 软件要求
- **操作系统**: Windows Server 2016+ 或 Windows 10/11
- **Node.js**: 18.0.0+ (LTS版本)
- **npm**: 9.0.0+
- **PowerShell**: 5.1+
- **IIS**: 8.0+ 或 Nginx 1.18+

## 2. 安装Node.js

### 2.1 下载Node.js
访问Node.js官网下载LTS版本:
https://nodejs.org/

推荐版本: Node.js 18.x LTS 或 20.x LTS

### 2.2 安装Node.js
1. 双击下载的安装包
2. 勾选"Automatically install the necessary tools"
3. 点击"Next"完成安装

### 2.3 验证安装
打开PowerShell，执行以下命令:

```powershell
node --version
npm --version
```

预期输出:
```
v18.19.0
9.6.7
```

### 2.4 配置npm镜像 (可选)
如果网络较慢，可以配置淘宝镜像:

```powershell
npm config set registry https://registry.npmmirror.com
npm config get registry
```

## 3. 安装IIS

### 3.1 启用IIS功能
1. 打开"控制面板" > "程序" > "启用或关闭Windows功能"
2. 勾选以下项目:
   - Internet Information Services
   - 万维网服务
   - 应用程序开发功能
     - CGI
     - ISAPI扩展
     - ISAPI筛选器
3. 点击"确定"安装

### 3.2 验证IIS安装
1. 打开浏览器，访问: http://localhost
2. 如果看到IIS欢迎页面，说明安装成功

### 3.3 配置IIS
1. 打开"IIS管理器"
2. 确保以下功能已启用:
   - 静态内容
   - 默认文档
   - 目录浏览

## 4. 安装URL重写模块 (可选)

### 4.1 下载URL重写模块
下载地址:
https://www.iis.net/downloads/microsoft/url-rewrite

### 4.2 安装URL重写模块
1. 双击下载的安装包
2. 按照向导完成安装

## 5. 配置防火墙

### 5.1 开放端口
在PowerShell中执行以下命令:

```powershell
# 开放HTTP端口 (80)
New-NetFirewallRule -DisplayName "HTTP" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow

# 开放HTTPS端口 (443)
New-NetFirewallRule -DisplayName "HTTPS" -Direction Inbound -LocalPort 443 -Protocol TCP -Action Allow
```

### 5.2 验证防火墙规则
```powershell
Get-NetFirewallRule -DisplayName "HTTP"
Get-NetFirewallRule -DisplayName "HTTPS"
```

## 6. 创建部署目录

### 6.1 创建主目录
```powershell
# 创建主目录
New-Item -ItemType Directory -Path "D:\wiring-record-system" -Force

# 创建子目录
New-Item -ItemType Directory -Path "D:\wiring-record-system\frontend" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backend" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backend\uploads" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backend\logs" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backend\database" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\ssl" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\monitoring" -Force
```

### 6.2 验证目录创建
```powershell
Get-ChildItem -Path "D:\wiring-record-system" -Recurse
```

## 7. 安装全局工具

### 7.1 安装PM2 (进程管理)
```powershell
npm install -g pm2
npm install -g pm2-windows-startup
pm2-startup install
```

### 7.2 验证PM2安装
```powershell
pm2 --version
```

### 7.3 安装WinSW (Windows服务)
下载WinSW:
https://github.com/winsw/winsw/releases

下载最新版本的WinSW.exe，重命名为wiring-record-service.exe，放到:
```
D:\wiring-record-system\backend\
```

## 8. 配置环境变量

### 8.1 设置NODE_ENV
```powershell
# 设置系统环境变量
[Environment]::SetEnvironmentVariable("NODE_ENV", "production", "Machine")

# 验证
[Environment]::GetEnvironmentVariable("NODE_ENV", "Machine")
```

### 8.2 设置端口环境变量 (可选)
```powershell
# 设置后端端口
[Environment]::SetEnvironmentVariable("BACKEND_PORT", "3001", "Machine")

# 设置前端端口 (如果需要)
[Environment]::SetEnvironmentVariable("FRONTEND_PORT", "80", "Machine")
```

## 9. 配置PowerShell执行策略

### 9.1 检查执行策略
```powershell
Get-ExecutionPolicy
```

### 9.2 设置执行策略
如果执行策略是Restricted，需要修改:

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope LocalMachine
```

## 10. 安装Git (可选)

### 10.1 下载Git
访问Git官网下载:
https://git-scm.com/download/win

### 10.2 安装Git
1. 双击下载的安装包
2. 选择默认选项完成安装

### 10.3 验证Git安装
```powershell
git --version
```

## 11. 网络配置检查

### 11.1 检查公网IP
```powershell
# 检查本机IP
ipconfig

# 检查公网IP (通过外部服务)
Invoke-RestMethod -Uri "https://api.ipify.org?format=json"
```

### 11.2 检查端口连通性
```powershell
# 测试本地端口
Test-NetConnection -ComputerName localhost -Port 80
Test-NetConnection -ComputerName localhost -Port 443
```

## 12. 创建备份脚本目录

### 12.1 创建备份脚本目录
```powershell
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup\scripts" -Force
```

### 12.2 创建日志目录
```powershell
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup\logs" -Force
```

## 13. 环境检查清单

### 13.1 检查项
- [ ] Node.js已安装 (版本 >= 18.0.0)
- [ ] npm已安装 (版本 >= 9.0.0)
- [ ] IIS已安装并运行
- [ ] 防火墙端口已开放 (80, 443)
- [ ] 部署目录已创建
- [ ] PM2已安装
- [ ] WinSW已下载
- [ ] 环境变量已配置
- [ ] PowerShell执行策略已设置
- [ ] 网络连接正常

### 13.2 验证脚本
创建验证脚本 `check-env.ps1`:

```powershell
Write-Host "=== 环境检查 ===" -ForegroundColor Green

# 检查Node.js
$nodeVersion = node --version
Write-Host "Node.js版本: $nodeVersion" -ForegroundColor Cyan

# 检查npm
$npmVersion = npm --version
Write-Host "npm版本: $npmVersion" -ForegroundColor Cyan

# 检查IIS
$iisService = Get-Service -Name W3SVC -ErrorAction SilentlyContinue
if ($iisService) {
    Write-Host "IIS状态: $($iisService.Status)" -ForegroundColor Cyan
} else {
    Write-Host "IIS未安装" -ForegroundColor Red
}

# 检查目录
$directories = @(
    "D:\wiring-record-system",
    "D:\wiring-record-system\frontend",
    "D:\wiring-record-system\backend",
    "D:\wiring-record-system\backend\uploads",
    "D:\wiring-record-system\backend\logs",
    "D:\wiring-record-system\backend\database",
    "D:\wiring-record-system\ssl",
    "D:\wiring-record-system\backup"
)

Write-Host "`n目录检查:" -ForegroundColor Green
foreach ($dir in $directories) {
    if (Test-Path $dir) {
        Write-Host "✓ $dir" -ForegroundColor Green
    } else {
        Write-Host "✗ $dir" -ForegroundColor Red
    }
}

Write-Host "`n=== 环境检查完成 ===" -ForegroundColor Green
```

运行验证脚本:
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
.\check-env.ps1
```

## 14. 常见问题

### 14.1 Node.js安装失败
**问题**: 安装Node.js时出现错误

**解决方案**:
1. 以管理员身份运行安装程序
2. 检查杀毒软件是否阻止安装
3. 下载最新版本的Node.js

### 14.2 IIS安装失败
**问题**: 启用IIS功能时失败

**解决方案**:
1. 以管理员身份运行PowerShell
2. 使用DISM命令安装:
```powershell
DISM /Online /Enable-Feature /FeatureName:IIS-WebServer /All
```

### 14.3 防火墙规则添加失败
**问题**: 添加防火墙规则时权限不足

**解决方案**:
1. 以管理员身份运行PowerShell
2. 检查是否已有同名规则

### 14.4 目录创建失败
**问题**: 创建目录时权限不足

**解决方案**:
1. 以管理员身份运行PowerShell
2. 检查磁盘空间是否充足

## 15. 下一步

环境准备完成后，请继续阅读:
- [02-前端部署文档.md](./02-前端部署文档.md)
- [03-后端部署文档.md](./03-后端部署文档.md)

---

**文档版本**: v1.0
**创建日期**: 2025-12-30
**最后更新**: 2025-12-30
**维护人员**: 综合布线记录管理系统团队
