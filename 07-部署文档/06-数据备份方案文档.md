# 数据备份方案文档

## 1. 备份概述

### 1.1 备份重要性
- 防止数据丢失
- 应对系统故障
- 满足合规要求
- 支持灾难恢复

### 1.2 备份策略
- **数据库备份**: 每日自动备份
- **上传文件备份**: 每周自动备份
- **配置文件备份**: 每次修改后手动备份
- **备份保留**: 保留最近30天

## 2. 备份目录结构

```
D:\wiring-record-system\backup\
├── database\              # 数据库备份
│   ├── daily\            # 每日备份
│   └── weekly\           # 每周备份
├── uploads\              # 上传文件备份
│   ├── daily\            # 每日备份
│   └── weekly\           # 每周备份
├── config\               # 配置文件备份
└── logs\                 # 备份日志
```

### 2.1 创建备份目录
```powershell
# 创建备份目录结构
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup\database\daily" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup\database\weekly" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup\uploads\daily" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup\uploads\weekly" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup\config" -Force
New-Item -ItemType Directory -Path "D:\wiring-record-system\backup\logs" -Force
```

## 3. 数据库备份

### 3.1 SQLite数据库备份
SQLite数据库是单个文件，可以直接复制备份。

### 3.2 创建数据库备份脚本
创建 `D:\wiring-record-system\backup\scripts\backup-database.ps1`:

```powershell
# 数据库备份脚本
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$dbPath = "D:\wiring-record-system\backend\database\wiring-record.db"
$dailyBackupPath = "D:\wiring-record-system\backup\database\daily\wiring-record_$timestamp.db"
$weeklyBackupPath = "D:\wiring-record-system\backup\database\weekly\wiring-record_$timestamp.db"
$logPath = "D:\wiring-record-system\backup\logs\database-backup.log"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    Write-Log "开始数据库备份..."

    # 检查数据库文件是否存在
    if (-not (Test-Path $dbPath)) {
        throw "数据库文件不存在: $dbPath"
    }

    # 停止后端服务（确保数据一致性）
    Write-Log "停止后端服务..."
    Stop-Service -Name "wiring-record-backend" -Force
    Start-Sleep -Seconds 5

    # 复制数据库文件
    Write-Log "复制数据库文件到每日备份目录..."
    Copy-Item -Path $dbPath -Destination $dailyBackupPath -Force

    # 检查是否是周日（执行每周备份）
    if ((Get-Date).DayOfWeek -eq "Sunday") {
        Write-Log "执行每周备份..."
        Copy-Item -Path $dbPath -Destination $weeklyBackupPath -Force
    }

    # 启动后端服务
    Write-Log "启动后端服务..."
    Start-Service -Name "wiring-record-backend"
    Start-Sleep -Seconds 5

    # 验证备份文件
    if (Test-Path $dailyBackupPath) {
        $backupSize = (Get-Item $dailyBackupPath).Length
        Write-Log "数据库备份成功，文件大小: $backupSize 字节"
    } else {
        throw "备份文件创建失败"
    }

    # 清理旧备份（保留30天）
    Write-Log "清理旧备份文件..."
    $cutoffDate = (Get-Date).AddDays(-30)
    Get-ChildItem -Path "D:\wiring-record-system\backup\database\daily" -Filter "*.db" | 
        Where-Object { $_.LastWriteTime -lt $cutoffDate } | 
        Remove-Item -Force

    Get-ChildItem -Path "D:\wiring-record-system\backup\database\weekly" -Filter "*.db" | 
        Where-Object { $_.LastWriteTime -lt $cutoffDate } | 
        Remove-Item -Force

    Write-Log "旧备份清理完成"

    Write-Log "数据库备份完成"

} catch {
    Write-Log "数据库备份失败: $_"
    
    # 尝试启动服务
    try {
        Start-Service -Name "wiring-record-backend"
    } catch {
        Write-Log "启动服务失败: $_"
    }
    
    # 发送告警邮件
    try {
        Send-MailMessage -From "backup@company.com" -To "admin@company.com" -Subject "数据库备份失败" -Body "数据库备份失败: $_" -SmtpServer "smtp.company.com"
    } catch {
        Write-Log "发送告警邮件失败: $_"
    }
    
    exit 1
}
```

### 3.3 配置定时备份任务
```powershell
# 创建每日备份任务（每天凌晨2点）
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\backup\scripts\backup-database.ps1"
$trigger = New-ScheduledTaskTrigger -Daily -At "02:00"
Register-ScheduledTask -TaskName "Backup Database" -Action $action -Trigger $trigger -RunLevel Highest -Description "每日数据库备份任务"

# 验证任务创建
Get-ScheduledTask -TaskName "Backup Database"
```

## 4. 上传文件备份

### 4.1 创建上传文件备份脚本
创建 `D:\wiring-record-system\backup\scripts\backup-uploads.ps1`:

```powershell
# 上传文件备份脚本
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$uploadsPath = "D:\wiring-record-system\backend\uploads"
$dailyBackupPath = "D:\wiring-record-system\backup\uploads\daily\uploads_$timestamp.zip"
$weeklyBackupPath = "D:\wiring-record-system\backup\uploads\weekly\uploads_$timestamp.zip"
$logPath = "D:\wiring-record-system\backup\logs\uploads-backup.log"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    Write-Log "开始上传文件备份..."

    # 检查上传目录是否存在
    if (-not (Test-Path $uploadsPath)) {
        Write-Log "上传目录不存在，跳过备份"
        exit 0
    }

    # 检查是否有文件需要备份
    $files = Get-ChildItem -Path $uploadsPath -Recurse -File
    if ($files.Count -eq 0) {
        Write-Log "没有文件需要备份"
        exit 0
    }

    # 创建每日备份（压缩）
    Write-Log "创建每日备份压缩包..."
    Compress-Archive -Path $uploadsPath -DestinationPath $dailyBackupPath -Force

    # 检查是否是周日（执行每周备份）
    if ((Get-Date).DayOfWeek -eq "Sunday") {
        Write-Log "执行每周备份..."
        Compress-Archive -Path $uploadsPath -DestinationPath $weeklyBackupPath -Force
    }

    # 验证备份文件
    if (Test-Path $dailyBackupPath) {
        $backupSize = (Get-Item $dailyBackupPath).Length
        Write-Log "上传文件备份成功，文件大小: $backupSize 字节"
    } else {
        throw "备份文件创建失败"
    }

    # 清理旧备份（保留30天）
    Write-Log "清理旧备份文件..."
    $cutoffDate = (Get-Date).AddDays(-30)
    Get-ChildItem -Path "D:\wiring-record-system\backup\uploads\daily" -Filter "*.zip" | 
        Where-Object { $_.LastWriteTime -lt $cutoffDate } | 
        Remove-Item -Force

    Get-ChildItem -Path "D:\wiring-record-system\backup\uploads\weekly" -Filter "*.zip" | 
        Where-Object { $_.LastWriteTime -lt $cutoffDate } | 
        Remove-Item -Force

    Write-Log "旧备份清理完成"

    Write-Log "上传文件备份完成"

} catch {
    Write-Log "上传文件备份失败: $_"
    
    # 发送告警邮件
    try {
        Send-MailMessage -From "backup@company.com" -To "admin@company.com" -Subject "上传文件备份失败" -Body "上传文件备份失败: $_" -SmtpServer "smtp.company.com"
    } catch {
        Write-Log "发送告警邮件失败: $_"
    }
    
    exit 1
}
```

### 4.2 配置定时备份任务
```powershell
# 创建每周备份任务（每周日凌晨3点）
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\backup\scripts\backup-uploads.ps1"
$trigger = New-ScheduledTaskTrigger -Weekly -DaysOfWeek Sunday -At "03:00"
Register-ScheduledTask -TaskName "Backup Uploads" -Action $action -Trigger $trigger -RunLevel Highest -Description "每周上传文件备份任务"

# 验证任务创建
Get-ScheduledTask -TaskName "Backup Uploads"
```

## 5. 配置文件备份

### 5.1 手动备份脚本
创建 `D:\wiring-record-system\backup\scripts\backup-config.ps1`:

```powershell
# 配置文件备份脚本
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$backupPath = "D:\wiring-record-system\backup\config\config_$timestamp.zip"
$logPath = "D:\wiring-record-system\backup\logs\config-backup.log"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    Write-Log "开始配置文件备份..."

    # 要备份的配置文件列表
    $configFiles = @(
        "D:\wiring-record-system\backend\.env",
        "D:\wiring-record-system\backend\package.json",
        "D:\wiring-record-system\backend\wiring-record-service.xml",
        "D:\wiring-record-system\frontend\web.config"
    )

    # 创建临时目录
    $tempDir = "D:\wiring-record-system\backup\config\temp_$timestamp"
    New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

    # 复制配置文件
    foreach ($file in $configFiles) {
        if (Test-Path $file) {
            $fileName = Split-Path $file -Leaf
            Copy-Item -Path $file -Destination "$tempDir\$fileName" -Force
            Write-Log "备份配置文件: $fileName"
        } else {
            Write-Log "警告: 配置文件不存在: $file"
        }
    }

    # 创建压缩包
    Write-Log "创建配置备份压缩包..."
    Compress-Archive -Path "$tempDir\*" -DestinationPath $backupPath -Force

    # 删除临时目录
    Remove-Item -Path $tempDir -Recurse -Force

    # 验证备份文件
    if (Test-Path $backupPath) {
        $backupSize = (Get-Item $backupPath).Length
        Write-Log "配置文件备份成功，文件大小: $backupSize 字节"
    } else {
        throw "备份文件创建失败"
    }

    # 清理旧备份（保留最近10个）
    Write-Log "清理旧备份文件..."
    $oldBackups = Get-ChildItem -Path "D:\wiring-record-system\backup\config" -Filter "*.zip" | 
                  Sort-Object LastWriteTime -Descending | 
                  Select-Object -Skip 10
    
    $oldBackups | Remove-Item -Force

    Write-Log "配置文件备份完成"

} catch {
    Write-Log "配置文件备份失败: $_"
    exit 1
}
```

### 5.2 使用方法
在修改配置文件后，手动执行备份:
```powershell
cd D:\wiring-record-system\backup\scripts
.\backup-config.ps1
```

## 6. 数据恢复

### 6.1 数据库恢复
创建 `D:\wiring-record-system\backup\scripts\restore-database.ps1`:

```powershell
# 数据库恢复脚本
param(
    [Parameter(Mandatory=$true)]
    [string]$BackupFile
)

$dbPath = "D:\wiring-record-system\backend\database\wiring-record.db"
$logPath = "D:\wiring-record-system\backup\logs\database-restore.log"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    Write-Log "开始数据库恢复..."
    Write-Log "备份文件: $BackupFile"

    # 检查备份文件是否存在
    if (-not (Test-Path $BackupFile)) {
        throw "备份文件不存在: $BackupFile"
    }

    # 停止后端服务
    Write-Log "停止后端服务..."
    Stop-Service -Name "wiring-record-backend" -Force
    Start-Sleep -Seconds 5

    # 备份当前数据库
    $currentBackup = "D:\wiring-record-system\backup\database\daily\before_restore_$(Get-Date -Format 'yyyyMMdd_HHmmss').db"
    Write-Log "备份当前数据库到: $currentBackup"
    Copy-Item -Path $dbPath -Destination $currentBackup -Force

    # 恢复数据库
    Write-Log "恢复数据库..."
    Copy-Item -Path $BackupFile -Destination $dbPath -Force

    # 启动后端服务
    Write-Log "启动后端服务..."
    Start-Service -Name "wiring-record-backend"
    Start-Sleep -Seconds 5

    # 验证服务状态
    $service = Get-Service -Name "wiring-record-backend"
    if ($service.Status -eq "Running") {
        Write-Log "数据库恢复成功"
    } else {
        throw "后端服务启动失败"
    }

} catch {
    Write-Log "数据库恢复失败: $_"
    
    # 尝试恢复之前的备份
    try {
        if (Test-Path $currentBackup) {
            Write-Log "尝试恢复之前的备份..."
            Copy-Item -Path $currentBackup -Destination $dbPath -Force
            Start-Service -Name "wiring-record-backend"
        }
    } catch {
        Write-Log "恢复失败: $_"
    }
    
    exit 1
}
```

### 6.2 上传文件恢复
创建 `D:\wiring-record-system\backup\scripts\restore-uploads.ps1`:

```powershell
# 上传文件恢复脚本
param(
    [Parameter(Mandatory=$true)]
    [string]$BackupFile
)

$uploadsPath = "D:\wiring-record-system\backend\uploads"
$logPath = "D:\wiring-record-system\backup\logs\uploads-restore.log"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    Write-Log "开始上传文件恢复..."
    Write-Log "备份文件: $BackupFile"

    # 检查备份文件是否存在
    if (-not (Test-Path $BackupFile)) {
        throw "备份文件不存在: $BackupFile"
    }

    # 备份当前上传目录
    $currentBackup = "D:\wiring-record-system\backup\uploads\daily\before_restore_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
    Write-Log "备份当前上传目录..."
    Compress-Archive -Path $uploadsPath -DestinationPath $currentBackup -Force

    # 清空上传目录
    Write-Log "清空上传目录..."
    Remove-Item -Path "$uploadsPath\*" -Recurse -Force

    # 恢复上传文件
    Write-Log "恢复上传文件..."
    Expand-Archive -Path $BackupFile -DestinationPath $uploadsPath -Force

    Write-Log "上传文件恢复成功"

} catch {
    Write-Log "上传文件恢复失败: $_"
    
    # 尝试恢复之前的备份
    try {
        if (Test-Path $currentBackup) {
            Write-Log "尝试恢复之前的备份..."
            Remove-Item -Path "$uploadsPath\*" -Recurse -Force
            Expand-Archive -Path $currentBackup -DestinationPath $uploadsPath -Force
        }
    } catch {
        Write-Log "恢复失败: $_"
    }
    
    exit 1
}
```

## 7. 备份验证

### 7.1 创建备份验证脚本
创建 `D:\wiring-record-system\backup\scripts\verify-backup.ps1`:

```powershell
# 备份验证脚本
$logPath = "D:\wiring-record-system\backup\logs\verify-backup.log"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path $logPath -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

Write-Log "开始备份验证..."

# 验证数据库备份
Write-Log "验证数据库备份..."
$dbBackups = Get-ChildItem -Path "D:\wiring-record-system\backup\database\daily" -Filter "*.db" | 
             Sort-Object LastWriteTime -Descending | 
             Select-Object -First 1

if ($dbBackups) {
    $latestBackup = $dbBackups.FullName
    Write-Log "最新数据库备份: $latestBackup"
    
    # 检查文件大小
    $fileSize = (Get-Item $latestBackup).Length
    if ($fileSize -gt 0) {
        Write-Log "数据库备份文件大小: $fileSize 字节 - 正常"
    } else {
        Write-Log "警告: 数据库备份文件大小为0" -ForegroundColor Yellow
    }
} else {
    Write-Log "错误: 没有找到数据库备份" -ForegroundColor Red
}

# 验证上传文件备份
Write-Log "验证上传文件备份..."
$uploadBackups = Get-ChildItem -Path "D:\wiring-record-system\backup\uploads\daily" -Filter "*.zip" | 
                  Sort-Object LastWriteTime -Descending | 
                  Select-Object -First 1

if ($uploadBackups) {
    $latestBackup = $uploadBackups.FullName
    Write-Log "最新上传文件备份: $latestBackup"
    
    # 检查文件大小
    $fileSize = (Get-Item $latestBackup).Length
    if ($fileSize -gt 0) {
        Write-Log "上传文件备份文件大小: $fileSize 字节 - 正常"
    } else {
        Write-Log "警告: 上传文件备份文件大小为0" -ForegroundColor Yellow
    }
} else {
    Write-Log "警告: 没有找到上传文件备份" -ForegroundColor Yellow
}

# 统计备份文件数量
$dbCount = (Get-ChildItem -Path "D:\wiring-record-system\backup\database\daily" -Filter "*.db").Count
$uploadCount = (Get-ChildItem -Path "D:\wiring-record-system\backup\uploads\daily" -Filter "*.zip").Count

Write-Log "数据库备份文件数量: $dbCount"
Write-Log "上传文件备份文件数量: $uploadCount"

Write-Log "备份验证完成"
```

### 7.2 配置定时验证任务
```powershell
# 创建每周验证任务（每周日凌晨4点）
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\backup\scripts\verify-backup.ps1"
$trigger = New-ScheduledTaskTrigger -Weekly -DaysOfWeek Sunday -At "04:00"
Register-ScheduledTask -TaskName "Verify Backups" -Action $action -Trigger $trigger -RunLevel Highest -Description "每周备份验证任务"
```

## 8. 备份报告

### 8.1 创建备份报告脚本
创建 `D:\wiring-record-system\backup\scripts\backup-report.ps1`:

```powershell
# 备份报告脚本
$reportPath = "D:\wiring-record-system\backup\logs\backup-report_$(Get-Date -Format 'yyyyMMdd').txt"

# 生成报告
$report = @"
========================================
综合布线记录管理系统 - 备份报告
========================================
生成时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

1. 数据库备份
----------------------------------------
最新备份: $((Get-ChildItem -Path "D:\wiring-record-system\backup\database\daily" -Filter "*.db" | Sort-Object LastWriteTime -Descending | Select-Object -First 1).LastWriteTime)
备份文件数量: $((Get-ChildItem -Path "D:\wiring-record-system\backup\database\daily" -Filter "*.db").Count)
总大小: $([math]::Round(((Get-ChildItem -Path "D:\wiring-record-system\backup\database\daily" -Filter "*.db" | Measure-Object -Property Length -Sum).Sum / 1MB), 2)) MB

2. 上传文件备份
----------------------------------------
最新备份: $((Get-ChildItem -Path "D:\wiring-record-system\backup\uploads\daily" -Filter "*.zip" | Sort-Object LastWriteTime -Descending | Select-Object -First 1).LastWriteTime)
备份文件数量: $((Get-ChildItem -Path "D:\wiring-record-system\backup\uploads\daily" -Filter "*.zip").Count)
总大小: $([math]::Round(((Get-ChildItem -Path "D:\wiring-record-system\backup\uploads\daily" -Filter "*.zip" | Measure-Object -Property Length -Sum).Sum / 1MB), 2)) MB

3. 配置文件备份
----------------------------------------
备份文件数量: $((Get-ChildItem -Path "D:\wiring-record-system\backup\config" -Filter "*.zip").Count)

4. 磁盘空间
----------------------------------------
备份目录大小: $([math]::Round(((Get-ChildItem -Path "D:\wiring-record-system\backup" -Recurse | Measure-Object -Property Length -Sum).Sum / 1GB), 2)) GB
可用空间: $([math]::Round(((Get-PSDrive D).Free / 1GB), 2)) GB

========================================
"@

# 保存报告
$report | Out-File -FilePath $reportPath -Encoding UTF8

# 输出到控制台
Write-Host $report -ForegroundColor Cyan

# 发送邮件报告
try {
    Send-MailMessage -From "backup@company.com" -To "admin@company.com" -Subject "备份报告 - $(Get-Date -Format 'yyyy-MM-dd')" -Body $report -SmtpServer "smtp.company.com"
    Write-Host "备份报告已发送到邮箱" -ForegroundColor Green
} catch {
    Write-Host "发送备份报告失败: $_" -ForegroundColor Red
}
```

### 8.2 配置定时报告任务
```powershell
# 创建每周报告任务（每周一早上9点）
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File D:\wiring-record-system\backup\scripts\backup-report.ps1"
$trigger = New-ScheduledTaskTrigger -Weekly -DaysOfWeek Monday -At "09:00"
Register-ScheduledTask -TaskName "Backup Report" -Action $action -Trigger $trigger -RunLevel Highest -Description "每周备份报告任务"
```

## 9. 故障排查

### 9.1 备份失败
**问题**: 定时备份任务执行失败

**解决方案**:
1. 检查任务计划程序日志
2. 检查备份日志文件
3. 检查磁盘空间
4. 检查文件权限
5. 检查服务是否正常运行

### 9.2 备份文件损坏
**问题**: 备份文件无法打开或恢复

**解决方案**:
1. 使用较早的备份文件
2. 检查备份日志
3. 验证备份文件完整性
4. 重新执行备份

### 9.3 磁盘空间不足
**问题**: 备份导致磁盘空间不足

**解决方案**:
1. 减少备份保留天数
2. 增加磁盘空间
3. 清理不必要的备份
4. 使用压缩备份

## 10. 下一步

备份方案配置完成后，请继续阅读:
- [06-监控方案文档.md](./06-监控方案文档.md)
- [07-运维手册.md](./07-运维手册.md)

---

**文档版本**: v1.0
**创建日期**: 2025-12-30
**最后更新**: 2025-12-30
**维护人员**: 综合布线记录管理系统团队
