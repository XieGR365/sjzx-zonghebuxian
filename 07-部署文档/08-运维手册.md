# 运维手册

## 1. 概述

### 1.1 文档目的
本手册旨在为系统运维人员提供详细的操作指南，包括日常维护、故障处理、系统更新等内容。

### 1.2 适用范围
- 系统管理员
- 运维工程师
- 技术支持人员

### 1.3 系统架构
- 前端: Vue 3 + Element Plus
- 后端: Node.js + Express
- 数据库: SQLite
- Web服务器: IIS / Nginx
- 操作系统: Windows Server

## 2. 日常运维

### 2.1 系统启动

#### 2.1.1 启动后端服务
```powershell
# 方法1: 使用Windows服务
Start-Service -Name "wiring-record-backend"

# 方法2: 使用PM2
cd D:\wiring-record-system\backend
pm2 start dist/server.js --name wiring-record-backend

# 方法3: 手动启动
cd D:\wiring-record-system\backend
node dist/server.js
```

#### 2.1.2 启动前端服务
前端部署在IIS上，无需手动启动，IIS会自动处理请求。

#### 2.1.3 启动IIS服务
```powershell
# 启动IIS
Start-Service -Name "W3SVC"

# 重启IIS
iisreset
```

### 2.2 系统停止

#### 2.2.1 停止后端服务
```powershell
# 方法1: 使用Windows服务
Stop-Service -Name "wiring-record-backend"

# 方法2: 使用PM2
pm2 stop wiring-record-backend

# 方法3: 手动停止（Ctrl+C）
```

#### 2.2.2 停止IIS服务
```powershell
# 停止IIS
Stop-Service -Name "W3SVC"

# 重启IIS
iisreset /stop
```

### 2.3 系统重启

#### 2.3.1 重启后端服务
```powershell
# 方法1: 使用Windows服务
Restart-Service -Name "wiring-record-backend"

# 方法2: 使用PM2
pm2 restart wiring-record-backend
```

#### 2.3.2 重启IIS服务
```powershell
# 重启IIS
iisreset
```

### 2.4 服务状态检查

#### 2.4.1 检查后端服务状态
```powershell
# 方法1: 使用Windows服务
Get-Service -Name "wiring-record-backend"

# 方法2: 使用PM2
pm2 status

# 方法3: 检查进程
Get-Process -Name node -ErrorAction SilentlyContinue
```

#### 2.4.2 检查IIS服务状态
```powershell
# 检查IIS服务
Get-Service -Name "W3SVC"

# 检查IIS应用程序池
Get-WebApplication
```

#### 2.4.3 检查系统健康状态
```powershell
# 执行健康检查脚本
cd D:\wiring-record-system\monitoring\scripts
.\health-check.ps1
```

## 3. 日志管理

### 3.1 日志位置
- 后端日志: `D:\wiring-record-system\backend\logs\`
- 监控日志: `D:\wiring-record-system\monitoring\logs\`
- 备份日志: `D:\wiring-record-system\backup\logs\`
- IIS日志: `C:\inetpub\logs\LogFiles\`

### 3.2 查看日志

#### 3.2.1 查看后端日志
```powershell
# 查看最新的日志文件
Get-ChildItem -Path "D:\wiring-record-system\backend\logs" -Filter "*.log" | 
    Sort-Object LastWriteTime -Descending | 
    Select-Object -First 1 | 
    ForEach-Object { Get-Content $_.FullName -Tail 50 }

# 实时查看日志
Get-Content "D:\wiring-record-system\backend\logs\app.log" -Wait -Tail 50
```

#### 3.2.2 查看IIS日志
```powershell
# 查看最新的IIS日志
Get-ChildItem -Path "C:\inetpub\logs\LogFiles" -Recurse -Filter "*.log" | 
    Sort-Object LastWriteTime -Descending | 
    Select-Object -First 1 | 
    ForEach-Object { Get-Content $_.FullName -Tail 50 }
```

#### 3.2.3 查看监控日志
```powershell
# 查看监控日志
Get-ChildItem -Path "D:\wiring-record-system\monitoring\logs" -Filter "*.log" | 
    Sort-Object LastWriteTime -Descending | 
    Select-Object -First 1 | 
    ForEach-Object { Get-Content $_.FullName -Tail 50 }
```

### 3.3 日志清理

#### 3.3.1 清理后端日志
```powershell
# 清理30天前的日志
$cutoffDate = (Get-Date).AddDays(-30)
Get-ChildItem -Path "D:\wiring-record-system\backend\logs" -Filter "*.log" | 
    Where-Object { $_.LastWriteTime -lt $cutoffDate } | 
    Remove-Item -Force
```

#### 3.3.2 清理IIS日志
```powershell
# 清理30天前的IIS日志
$cutoffDate = (Get-Date).AddDays(-30)
Get-ChildItem -Path "C:\inetpub\logs\LogFiles" -Recurse -Filter "*.log" | 
    Where-Object { $_.LastWriteTime -lt $cutoffDate } | 
    Remove-Item -Force
```

#### 3.3.3 配置日志轮转
在 `D:\wiring-record-system\backend\wiring-record-service.xml` 中配置日志轮转:
```xml
<log mode="roll-by-size">
  <sizeThreshold>10240</sizeThreshold>
  <keepFiles>8</keepFiles>
</log>
```

## 4. 数据管理

### 4.1 数据库维护

#### 4.1.1 数据库优化
```powershell
# 创建数据库优化脚本
# D:\wiring-record-system\backend\scripts\optimize-database.ps1

$dbPath = "D:\wiring-record-system\backend\database\wiring-record.db"

# 使用SQLite命令行工具进行优化
& "D:\wiring-record-system\backend\tools\sqlite3.exe" $dbPath "VACUUM;"
& "D:\wiring-record-system\backend\tools\sqlite3.exe" $dbPath "ANALYZE;"
```

#### 4.1.2 数据库备份
参考 [06-数据备份方案文档.md](./06-数据备份方案文档.md)

#### 4.1.3 数据库恢复
参考 [06-数据备份方案文档.md](./06-数据备份方案文档.md)

### 4.2 数据清理

#### 4.2.1 清理上传文件
```powershell
# 清理30天前的上传文件
$cutoffDate = (Get-Date).AddDays(-30)
Get-ChildItem -Path "D:\wiring-record-system\backend\uploads" -Recurse -File | 
    Where-Object { $_.LastWriteTime -lt $cutoffDate } | 
    Remove-Item -Force
```

#### 4.2.2 清理临时文件
```powershell
# 清理临时文件
$tempDirs = @(
    "D:\wiring-record-system\backend\temp",
    "D:\wiring-record-system\frontend\temp"
)

foreach ($dir in $tempDirs) {
    if (Test-Path $dir) {
        Get-ChildItem -Path $dir -Recurse | Remove-Item -Force -Recurse
    }
}
```

## 5. 系统更新

### 5.1 后端更新

#### 5.1.1 更新流程
1. 停止后端服务
2. 备份当前版本
3. 部署新版本
4. 更新数据库（如需要）
5. 启动后端服务
6. 验证功能

#### 5.1.2 更新脚本
创建 `D:\wiring-record-system\backend\scripts\update-backend.ps1`:

```powershell
# 后端更新脚本
$backupPath = "D:\wiring-record-system\backup\backend\backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
$newVersionPath = "D:\wiring-record-system\backend\new-version"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path "D:\wiring-record-system\backend\logs\update.log" -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    Write-Log "开始后端更新..."
    
    # 1. 停止后端服务
    Write-Log "停止后端服务..."
    Stop-Service -Name "wiring-record-backend" -Force
    Start-Sleep -Seconds 5
    
    # 2. 备份当前版本
    Write-Log "备份当前版本到: $backupPath"
    New-Item -ItemType Directory -Path $backupPath -Force | Out-Null
    Copy-Item -Path "D:\wiring-record-system\backend\*" -Destination $backupPath -Recurse -Force
    
    # 3. 部署新版本
    if (Test-Path $newVersionPath) {
        Write-Log "部署新版本..."
        Copy-Item -Path "$newVersionPath\*" -Destination "D:\wiring-record-system\backend" -Recurse -Force
        
        # 4. 更新数据库（如需要）
        Write-Log "检查数据库更新..."
        if (Test-Path "D:\wiring-record-system\backend\scripts\migrate-database.ps1") {
            & "D:\wiring-record-system\backend\scripts\migrate-database.ps1"
        }
    } else {
        Write-Log "警告: 新版本目录不存在: $newVersionPath"
    }
    
    # 5. 启动后端服务
    Write-Log "启动后端服务..."
    Start-Service -Name "wiring-record-backend"
    Start-Sleep -Seconds 5
    
    # 6. 验证服务状态
    $service = Get-Service -Name "wiring-record-backend"
    if ($service.Status -eq "Running") {
        Write-Log "后端更新成功"
    } else {
        throw "后端服务启动失败"
    }
    
} catch {
    Write-Log "后端更新失败: $_"
    
    # 回滚到备份版本
    Write-Log "回滚到备份版本..."
    Stop-Service -Name "wiring-record-backend" -Force
    Remove-Item -Path "D:\wiring-record-system\backend\*" -Recurse -Force
    Copy-Item -Path "$backupPath\*" -Destination "D:\wiring-record-system\backend" -Recurse -Force
    Start-Service -Name "wiring-record-backend"
    
    exit 1
}
```

### 5.2 前端更新

#### 5.2.1 更新流程
1. 构建新版本
2. 备份当前版本
3. 部署新版本
4. 清理缓存
5. 验证功能

#### 5.2.2 更新脚本
创建 `D:\wiring-record-system\frontend\scripts\update-frontend.ps1`:

```powershell
# 前端更新脚本
$backupPath = "D:\wiring-record-system\backup\frontend\backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
$distPath = "D:\wiring-record-system\frontend\dist"
$iisPath = "C:\inetpub\wwwroot\wiring-record-system"

# 记录日志
function Write-Log {
    param([string]$message)
    $logMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $message"
    Add-Content -Path "D:\wiring-record-system\frontend\logs\update.log" -Value $logMessage
    Write-Host $logMessage -ForegroundColor Cyan
}

try {
    Write-Log "开始前端更新..."
    
    # 1. 构建新版本
    Write-Log "构建新版本..."
    cd D:\wiring-record-system\frontend
    npm run build
    
    # 2. 备份当前版本
    Write-Log "备份当前版本到: $backupPath"
    New-Item -ItemType Directory -Path $backupPath -Force | Out-Null
    Copy-Item -Path "$iisPath\*" -Destination $backupPath -Recurse -Force
    
    # 3. 部署新版本
    Write-Log "部署新版本..."
    Copy-Item -Path "$distPath\*" -Destination $iisPath -Recurse -Force
    
    # 4. 清理IIS缓存
    Write-Log "清理IIS缓存..."
    iisreset
    
    Write-Log "前端更新成功"
    
} catch {
    Write-Log "前端更新失败: $_"
    
    # 回滚到备份版本
    Write-Log "回滚到备份版本..."
    Remove-Item -Path "$iisPath\*" -Recurse -Force
    Copy-Item -Path "$backupPath\*" -Destination $iisPath -Recurse -Force
    iisreset
    
    exit 1
}
```

## 6. 故障处理

### 6.1 常见故障

#### 6.1.1 后端服务无法启动
**症状**: 后端服务启动失败

**排查步骤**:
1. 检查服务状态
2. 查看服务日志
3. 检查端口占用
4. 检查配置文件
5. 检查依赖项

**解决方案**:
```powershell
# 1. 检查服务状态
Get-Service -Name "wiring-record-backend"

# 2. 查看服务日志
Get-Content "D:\wiring-record-system\backend\logs\app.log" -Tail 100

# 3. 检查端口占用
netstat -ano | findstr :3001

# 4. 检查配置文件
Get-Content "D:\wiring-record-system\backend\.env"

# 5. 手动启动查看错误
cd D:\wiring-record-system\backend
node dist/server.js
```

#### 6.1.2 前端无法访问
**症状**: 前端页面无法打开

**排查步骤**:
1. 检查IIS服务状态
2. 检查IIS应用程序池
3. 检查网站绑定
4. 检查防火墙设置
5. 检查DNS解析

**解决方案**:
```powershell
# 1. 检查IIS服务状态
Get-Service -Name "W3SVC"

# 2. 检查IIS应用程序池
Get-WebApplication

# 3. 检查网站绑定
Get-Website

# 4. 重启IIS
iisreset

# 5. 检查防火墙
Get-NetFirewallRule | Where-Object { $_.DisplayName -like "*HTTP*" -or $_.DisplayName -like "*HTTPS*" }
```

#### 6.1.3 数据库连接失败
**症状**: 应用无法连接数据库

**排查步骤**:
1. 检查数据库文件是否存在
2. 检查数据库文件权限
3. 检查数据库文件是否损坏
4. 检查数据库路径配置

**解决方案**:
```powershell
# 1. 检查数据库文件
Test-Path "D:\wiring-record-system\backend\database\wiring-record.db"

# 2. 检查数据库文件权限
Get-Acl "D:\wiring-record-system\backend\database\wiring-record.db"

# 3. 检查数据库文件完整性
& "D:\wiring-record-system\backend\tools\sqlite3.exe" "D:\wiring-record-system\backend\database\wiring-record.db" "PRAGMA integrity_check;"

# 4. 检查数据库路径配置
Get-Content "D:\wiring-record-system\backend\.env" | Select-String "DATABASE_PATH"
```

#### 6.1.4 上传文件失败
**症状**: 用户无法上传文件

**排查步骤**:
1. 检查上传目录权限
2. 检查磁盘空间
3. 检查文件大小限制
4. 检查网络连接

**解决方案**:
```powershell
# 1. 检查上传目录权限
Get-Acl "D:\wiring-record-system\backend\uploads"

# 2. 检查磁盘空间
Get-PSDrive D | Select-Object Used, Free

# 3. 检查文件大小限制
Get-Content "D:\wiring-record-system\backend\.env" | Select-String "MAX_FILE_SIZE"
```

### 6.2 故障恢复

#### 6.2.1 服务崩溃恢复
```powershell
# 1. 停止服务
Stop-Service -Name "wiring-record-backend" -Force

# 2. 查看崩溃日志
Get-Content "D:\wiring-record-system\backend\logs\app.log" -Tail 200

# 3. 检查系统资源
Get-Counter '\Processor(_Total)\% Processor Time'
Get-Counter '\Memory\Available MBytes'

# 4. 重启服务
Start-Service -Name "wiring-record-backend"
```

#### 6.2.2 数据库损坏恢复
```powershell
# 1. 停止服务
Stop-Service -Name "wiring-record-backend" -Force

# 2. 备份损坏的数据库
Copy-Item "D:\wiring-record-system\backend\database\wiring-record.db" "D:\wiring-record-system\backend\database\wiring-record.db.corrupted"

# 3. 从备份恢复
Copy-Item "D:\wiring-record-system\backup\database\daily\wiring-record_YYYYMMDD_HHMMSS.db" "D:\wiring-record-system\backend\database\wiring-record.db"

# 4. 启动服务
Start-Service -Name "wiring-record-backend"
```

## 7. 性能优化

### 7.1 系统性能优化

#### 7.1.1 增加内存
如果系统内存不足，建议增加服务器内存。

#### 7.1.2 优化数据库
```powershell
# 定期执行数据库优化
& "D:\wiring-record-system\backend\tools\sqlite3.exe" "D:\wiring-record-system\backend\database\wiring-record.db" "VACUUM;"
& "D:\wiring-record-system\backend\tools\sqlite3.exe" "D:\wiring-record-system\backend\database\wiring-record.db" "ANALYZE;"
```

#### 7.1.3 清理日志
定期清理日志文件，释放磁盘空间。

### 7.2 应用性能优化

#### 7.2.1 启用压缩
在IIS中启用静态内容压缩和动态内容压缩。

#### 7.2.2 启用缓存
在IIS中启用浏览器缓存。

#### 7.2.3 优化数据库查询
定期分析慢查询，优化数据库索引。

## 8. 安全管理

### 8.1 访问控制

#### 8.1.1 限制访问IP
在IIS中配置IP地址和域名限制。

#### 8.1.2 启用HTTPS
参考 [05-HTTPS配置文档.md](./05-HTTPS配置文档.md)

#### 8.1.3 定期更新密码
定期更新数据库密码、API密钥等敏感信息。

### 8.2 安全审计

#### 8.2.1 审计日志
定期检查系统日志、应用日志、安全日志。

#### 8.2.2 漏洞扫描
定期进行漏洞扫描，及时修复安全漏洞。

#### 8.2.3 备份验证
定期验证备份数据的完整性和可恢复性。

## 9. 应急预案

### 9.1 服务中断
1. 立即通知相关人员
2. 检查服务状态和日志
3. 尝试重启服务
4. 如无法恢复，切换到备用服务器
5. 记录故障原因和处理过程

### 9.2 数据丢失
1. 立即停止所有写入操作
2. 从最近的备份恢复数据
3. 验证恢复的数据完整性
4. 分析数据丢失原因
5. 采取措施防止再次发生

### 9.3 安全事件
1. 立即隔离受影响的系统
2. 评估安全事件影响范围
3. 通知安全团队和管理层
4. 收集证据和日志
5. 修复安全漏洞
6. 恢复系统运行
7. 总结经验教训

## 10. 联系信息

### 10.1 技术支持
- 技术支持邮箱: support@company.com
- 技术支持电话: XXX-XXXX-XXXX

### 10.2 紧急联系
- 紧急联系人: XXX
- 紧急联系电话: XXX-XXXX-XXXX

### 10.3 相关文档
- [01-部署架构方案.md](./01-部署架构方案.md)
- [02-环境准备文档.md](./02-环境准备文档.md)
- [03-前端部署文档.md](./03-前端部署文档.md)
- [04-后端部署文档.md](./04-后端部署文档.md)
- [05-HTTPS配置文档.md](./05-HTTPS配置文档.md)
- [06-数据备份方案文档.md](./06-数据备份方案文档.md)
- [07-监控方案文档.md](./07-监控方案文档.md)

---

**文档版本**: v1.0
**创建日期**: 2025-12-30
**最后更新**: 2025-12-30
**维护人员**: 综合布线记录管理系统团队
