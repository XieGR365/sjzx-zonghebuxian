# 用户故事 US-005：处理重复布线记录

## 1. 用户角色
系统用户

## 2. 用户故事描述
作为一个系统用户，我希望在上传综合布线记录时，系统能够自动识别重复的记录并进行替换更新，避免数据库中出现重复数据。

## 3. 验收标准
### 3.1 功能要求
- [ ] 上传文件时自动检测重复记录
- [ ] 重复记录识别规则：基于唯一标识字段（登记表编号、机房名称、线路编号等）
- [ ] 发现重复记录时，用新数据替换旧数据
- [ ] 非重复记录正常插入数据库
- [ ] 显示处理结果：新增记录数、更新记录数、失败记录数

### 3.2 重复识别规则（按优先级排序）
- [ ] 优先级1：任务单需求编号（IDC需求编号）
- [ ] 优先级2：YES工单编号
- [ ] 优先级3：链路编号（线路编号）
- [ ] 优先级4：登记表编号（如果存在）
- [ ] 优先级5：组合键识别：机房名称 + 线路编号
- [ ] 优先级6：组合键识别：机房名称 + 用户单位 + 线路编号
- [ ] 支持配置自定义识别规则

### 3.3 界面要求
- [ ] 上传完成后显示处理统计
- [ ] 明确标注哪些记录被更新
- [ ] 提供重复记录查看功能
- [ ] 支持撤销更新操作（可选）

### 3.4 数据完整性要求
- [ ] 更新时保留原有记录的创建时间
- [ ] 更新记录的最后修改时间
- [ ] 记录更新操作日志
- [ ] 支持数据版本追溯

## 4. 技术实现要点
- 后端实现重复检测逻辑
- 使用UPSERT操作（INSERT OR REPLACE）
- 建立唯一索引或复合索引提高查询效率
- 记录操作日志到operation_logs表
- 前端展示处理结果统计

## 5. 备注
- 优先使用任务单需求编号（IDC需求编号）作为唯一标识
- 如果任务单需求编号不存在，使用YES工单编号
- 如果YES工单编号不存在，使用链路编号（线路编号）
- 如果以上都不存在，使用登记表编号或组合键
- 快速开发版本，识别规则固定配置
