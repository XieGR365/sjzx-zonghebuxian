# 综合布线记录管理系统 - 部署和启动指南

> 本文档提供综合布线记录管理系统的详细部署和启动指南

## 目录

- [环境要求](#环境要求)
- [安装 Node.js](#安装-nodejs)
- [安装依赖](#安装依赖)
- [启动服务](#启动服务)
- [访问系统](#访问系统)
- [生产部署](#生产部署)
- [Docker 部署](#docker-部署)
- [数据备份与恢复](#数据备份与恢复)
- [常见问题](#常见问题)
- [故障排查](#故障排查)
- [性能优化](#性能优化)
- [安全配置](#安全配置)

## 环境要求

### 硬件要求

| 配置项 | 最低配置 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 硬盘 | 10GB | 50GB+ SSD |
| 网络 | 100Mbps | 1Gbps |

### 软件要求

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| **Node.js** | 18.0.0+ | JavaScript运行时环境 |
| **npm** | 9.0.0+ | 包管理器（随Node.js安装） |
| **Git** | 2.0+ | 版本控制（可选） |
| **浏览器** | Chrome 90+ / Firefox 88+ / Safari 14+ / Edge 90+ | 客户端浏览器 |

### 操作系统支持

- Windows 10/11
- macOS 10.15+
- Linux (Ubuntu 20.04+, CentOS 7+, Debian 10+)

## 检查环境

打开命令行（PowerShell、CMD 或 Terminal），运行以下命令检查环境：

```powershell
# 检查 Node.js 版本
node --version

# 检查 npm 版本
npm --version

# 检查 Git 版本（可选）
git --version
```

**预期输出**:
```
v18.x.x
9.x.x
git version 2.x.x
```

如果显示版本号，说明已安装。如果提示"无法识别命令"，需要先安装 Node.js。

## 安装 Node.js

### Windows 系统

#### 方法一：使用官方安装包（推荐）

1. 访问 Node.js 官网：https://nodejs.org/
2. 下载 **LTS（长期支持）** 版本的 Windows 安装包（.msi）
3. 运行安装程序，按照提示完成安装
4. 重新打开命令行，验证安装：
   ```powershell
   node --version
   npm --version
   ```

#### 方法二：使用 Chocolatey

如果已安装 Chocolatey，可以使用以下命令安装：

```powershell
choco install nodejs-lts
```

#### 方法三：使用 nvm-windows（推荐开发者）

1. 下载 nvm-windows：https://github.com/coreybutler/nvm-windows/releases
2. 安装 nvm-windows
3. 安装 Node.js：
   ```powershell
   nvm install 18
   nvm use 18
   ```

### macOS 系统

#### 方法一：使用 Homebrew（推荐）

```bash
brew install node
```

#### 方法二：使用官方安装包

1. 访问 Node.js 官网：https://nodejs.org/
2. 下载 macOS 安装包（.pkg）
3. 运行安装程序，按照提示完成安装

#### 方法三：使用 nvm（推荐开发者）

```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

### Linux 系统

#### Ubuntu/Debian

```bash
# 使用 NodeSource 仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### CentOS/RHEL

```bash
# 使用 NodeSource 仓库
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node --version
npm --version
```

#### 使用 nvm（推荐开发者）

```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

## 安装依赖

### 1. 安装后端依赖

```powershell
cd d:\TREA\sjzx-zonghebuxian\backend
npm install
```

**说明**:
- `npm install` 会根据 `package.json` 安装所有依赖
- 首次安装可能需要几分钟时间
- 如果安装失败，可以尝试使用 `npm install --legacy-peer-deps`

### 2. 安装前端依赖

```powershell
cd d:\TREA\sjzx-zonghebuxian\frontend
npm install
```

**说明**:
- 前端依赖包括 Vue 3、Element Plus、Vite 等
- 安装完成后会生成 `node_modules` 目录

### 3. 验证依赖安装

检查 `node_modules` 目录是否生成，以及 `package-lock.json` 文件是否存在。

## 配置环境

### 后端环境配置

编辑 `backend/.env` 文件：

```env
# 服务端口
PORT=3001

# 跨域允许的源地址（开发环境）
CORS_ORIGIN=http://localhost:5173

# 数据库文件路径
DB_PATH=./data/wiring.db

# 上传文件目录
UPLOAD_DIR=./uploads

# 最大文件大小（字节，默认10MB）
MAX_FILE_SIZE=10485760

# 日志级别（debug, info, warn, error）
LOG_LEVEL=info
```

**配置说明**:
- `PORT`: 后端服务监听端口，可根据需要修改
- `CORS_ORIGIN`: 允许跨域的前端地址，生产环境应配置为实际域名
- `DB_PATH`: SQLite 数据库文件路径
- `UPLOAD_DIR`: 上传文件存储目录
- `MAX_FILE_SIZE`: 上传文件大小限制（字节）
- `LOG_LEVEL`: 日志级别，生产环境建议使用 `info` 或 `warn`

### 前端环境配置

编辑 `frontend/.env` 文件：

```env
# API基础URL
VITE_API_BASE_URL=http://localhost:3001

# 应用标题
VITE_APP_TITLE=综合布线记录管理系统

# 上传文件大小限制（MB）
VITE_MAX_FILE_SIZE=10
```

**配置说明**:
- `VITE_API_BASE_URL`: 后端 API 地址，生产环境应配置为实际域名
- `VITE_APP_TITLE`: 应用标题，显示在浏览器标签页
- `VITE_MAX_FILE_SIZE`: 前端上传文件大小限制（MB）

### 创建必要的目录

```powershell
# 创建后端数据目录
mkdir d:\TREA\sjzx-zonghebuxian\backend\data

# 创建后端上传目录
mkdir d:\TREA\sjzx-zonghebuxian\backend\uploads
```

## 启动服务

### 开发环境

#### 启动后端服务

打开第一个命令行窗口：

```powershell
cd d:\TREA\sjzx-zonghebuxian\backend
npm run dev
```

**预期输出**:
```
综合布线记录管理系统后端服务已启动
服务地址: http://localhost:3001
健康检查: http://localhost:3001/health
```

**说明**:
- `npm run dev` 使用 `ts-node` 直接运行 TypeScript 代码
- 支持热重载，修改代码后自动重启服务
- 后端服务将在 `http://localhost:3001` 启动

#### 启动前端应用

打开第二个命令行窗口：

```powershell
cd d:\TREA\sjzx-zonghebuxian\frontend
npm run dev
```

**预期输出**:
```
  VITE v5.x.x  ready in xxx ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
```

**说明**:
- `npm run dev` 使用 Vite 启动开发服务器
- 支持热模块替换（HMR），修改代码后自动刷新
- 前端应用将在 `http://localhost:5173` 启动

### 生产环境

#### 构建后端

```powershell
cd d:\TREA\sjzx-zonghebuxian\backend
npm run build
npm start
```

**说明**:
- `npm run build` 将 TypeScript 编译为 JavaScript
- 编译后的代码位于 `dist` 目录
- `npm start` 运行编译后的代码

#### 构建前端

```powershell
cd d:\TREA\sjzx-zonghebuxian\frontend
npm run build
```

**说明**:
- `npm run build` 构建生产版本
- 构建产物位于 `dist` 目录
- 需要将 `dist` 目录部署到 Web 服务器

#### 使用 PM2 管理后端服务（推荐）

```powershell
# 安装 PM2
npm install -g pm2

# 启动后端服务
cd d:\TREA\sjzx-zonghebuxian\backend
pm2 start dist/server.js --name wiring-backend

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
```

**说明**:
- PM2 是一个 Node.js 进程管理器
- 支持自动重启、日志管理、监控等功能
- 适合生产环境使用

## 访问系统

启动成功后，在浏览器中访问：

```
http://localhost:5173
```

### 健康检查

检查后端服务是否正常运行：

```powershell
curl http://localhost:3001/health
```

**预期输出**:
```json
{
  "status": "ok",
  "message": "综合布线记录管理系统后端服务正常运行",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## 生产部署

### 使用 Nginx 部署

#### 1. 构建前端

```powershell
cd d:\TREA\sjzx-zonghebuxian\frontend
npm run build
```

#### 2. 安装 Nginx

**Ubuntu/Debian**:
```bash
sudo apt-get update
sudo apt-get install nginx
```

**CentOS/RHEL**:
```bash
sudo yum install nginx
```

**Windows**:
下载 Nginx for Windows：http://nginx.org/en/download.html

#### 3. 配置 Nginx

编辑 Nginx 配置文件（通常位于 `/etc/nginx/sites-available/default` 或 `nginx/conf/nginx.conf`）：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    root /path/to/frontend/dist;
    index index.html;

    # 前端路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 4. 启动 Nginx

```bash
# 测试配置
sudo nginx -t

# 启动 Nginx
sudo systemctl start nginx

# 设置开机自启
sudo systemctl enable nginx
```

### 使用 Apache 部署

#### 1. 构建前端

```powershell
cd d:\TREA\sjzx-zonghebuxian\frontend
npm run build
```

#### 2. 安装 Apache

**Ubuntu/Debian**:
```bash
sudo apt-get update
sudo apt-get install apache2
```

**CentOS/RHEL**:
```bash
sudo yum install httpd
```

#### 3. 配置 Apache

编辑 Apache 配置文件（通常位于 `/etc/apache2/sites-available/000-default.conf` 或 `/etc/httpd/conf/httpd.conf`）：

```apache
<VirtualHost *:80>
    ServerName your-domain.com

    # 前端静态文件
    DocumentRoot /path/to/frontend/dist

    # 前端路由支持
    <Directory /path/to/frontend/dist>
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # 后端 API 代理
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api

    # 静态资源缓存
    <LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </LocationMatch>
</VirtualHost>
```

#### 4. 启动 Apache

```bash
# 启用 rewrite 模块
sudo a2enmod rewrite
sudo a2enmod proxy
sudo a2enmod proxy_http

# 启动 Apache
sudo systemctl start apache2

# 设置开机自启
sudo systemctl enable apache2
```

## Docker 部署

### 后端 Docker 部署

#### 1. 创建 Dockerfile

在 `backend` 目录下创建 `Dockerfile`：

```dockerfile
FROM node:18-alpine

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建项目
RUN npm run build

# 创建必要的目录
RUN mkdir -p data uploads

# 暴露端口
EXPOSE 3001

# 启动服务
CMD ["npm", "start"]
```

#### 2. 构建 Docker 镜像

```bash
cd d:\TREA\sjzx-zonghebuxian\backend
docker build -t wiring-backend .
```

#### 3. 运行 Docker 容器

```bash
docker run -d \
  --name wiring-backend \
  -p 3001:3001 \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/uploads:/app/uploads \
  --restart unless-stopped \
  wiring-backend
```

### 前端 Docker 部署

#### 1. 创建 Dockerfile

在 `frontend` 目录下创建 `Dockerfile`：

```dockerfile
# 构建阶段
FROM node:18-alpine as builder

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm ci

# 复制源代码
COPY . .

# 构建项目
RUN npm run build

# 生产阶段
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动 Nginx
CMD ["nginx", "-g", "daemon off;"]
```

#### 2. 创建 Nginx 配置

在 `frontend` 目录下创建 `nginx.conf`：

```nginx
server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://wiring-backend:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 3. 构建 Docker 镜像

```bash
cd d:\TREA\sjzx-zonghebuxian\frontend
docker build -t wiring-frontend .
```

#### 4. 运行 Docker 容器

```bash
docker run -d \
  --name wiring-frontend \
  -p 80:80 \
  --link wiring-backend:wiring-backend \
  --restart unless-stopped \
  wiring-frontend
```

### 使用 Docker Compose

在项目根目录下创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    container_name: wiring-backend
    ports:
      - "3001:3001"
    volumes:
      - ./backend/data:/app/data
      - ./backend/uploads:/app/uploads
    restart: unless-stopped
    environment:
      - PORT=3001
      - CORS_ORIGIN=http://localhost

  frontend:
    build: ./frontend
    container_name: wiring-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped
```

启动所有服务：

```bash
docker-compose up -d
```

## 数据备份与恢复

### 备份数据库

#### 手动备份

```powershell
# 复制数据库文件
copy d:\TREA\sjzx-zonghebuxian\backend\data\wiring.db d:\backup\wiring_backup_$(date +%Y%m%d_%H%M%S).db
```

#### 自动备份（Linux）

创建备份脚本 `backup.sh`：

```bash
#!/bin/bash

BACKUP_DIR="/path/to/backup"
DB_FILE="/path/to/backend/data/wiring.db"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp $DB_FILE $BACKUP_DIR/wiring_backup_$DATE.db

# 保留最近7天的备份
find $BACKUP_DIR -name "wiring_backup_*.db" -mtime +7 -delete
```

设置定时任务：

```bash
crontab -e
```

添加以下内容（每天凌晨2点备份）：

```
0 2 * * * /path/to/backup.sh
```

### 恢复数据库

```powershell
# 停止后端服务
# 复制备份文件到数据目录
copy d:\backup\wiring_backup_20240101_020000.db d:\TREA\sjzx-zonghebuxian\backend\data\wiring.db

# 重启后端服务
```

## 常见问题

### 1. npm 命令无法识别

**问题**: 提示"无法将'npm'项识别为 cmdlet、函数、脚本文件或可运行程序的名称"

**解决方法**:
1. 确认已安装 Node.js
2. 重新打开命令行窗口
3. 检查环境变量 PATH 是否包含 Node.js 安装路径
4. 尝试重启计算机

### 2. 端口被占用

**问题**: 启动时提示端口已被占用

**解决方法**:

**Windows**:
```powershell
# 查看端口占用情况
netstat -ano | findstr :3001

# 终止占用端口的进程
taskkill /PID <进程ID> /F
```

**Linux/macOS**:
```bash
# 查看端口占用情况
lsof -i :3001

# 终止占用端口的进程
kill -9 <进程ID>
```

或者修改配置文件中的端口号：
- 后端：修改 `backend/.env` 中的 `PORT`
- 前端：修改 `frontend/vite.config.ts` 中的 `server.port`

### 3. 数据库文件权限问题

**问题**: 提示无法创建数据库文件

**解决方法**:

**Windows**:
```powershell
# 检查目录权限
icacls d:\TREA\sjzx-zonghebuxian\backend\data

# 修改目录权限
icacls d:\TREA\sjzx-zonghebuxian\backend\data /grant Users:F
```

**Linux/macOS**:
```bash
# 修改目录权限
chmod 755 /path/to/backend/data
chown -R $USER:$USER /path/to/backend/data
```

### 4. 跨域问题

**问题**: 前端无法访问后端 API

**解决方法**:
1. 确认后端服务已启动
2. 检查 `backend/.env` 文件中的 `CORS_ORIGIN` 配置
3. 确认前端代理配置正确
4. 检查防火墙设置

### 5. 依赖安装失败

**问题**: `npm install` 失败

**解决方法**:
1. 清除 npm 缓存：
   ```powershell
   npm cache clean --force
   ```
2. 删除 `node_modules` 目录和 `package-lock.json` 文件
3. 重新安装依赖：
   ```powershell
   npm install
   ```
4. 如果仍然失败，尝试使用国内镜像：
   ```powershell
   npm config set registry https://registry.npmmirror.com
   npm install
   ```

### 6. 构建失败

**问题**: `npm run build` 失败

**解决方法**:
1. 检查 TypeScript 配置
2. 检查代码语法错误
3. 查看详细的错误信息
4. 确保所有依赖已正确安装

## 故障排查

### 查看日志

#### 后端日志

**开发环境**:
```powershell
cd d:\TREA\sjzx-zonghebuxian\backend
npm run dev
```

**生产环境（PM2）**:
```powershell
pm2 logs wiring-backend
```

**Docker 环境**:
```bash
docker logs wiring-backend
```

#### 前端日志

**开发环境**:
```powershell
cd d:\TREA\sjzx-zonghebuxian\frontend
npm run dev
```

**生产环境**:
查看浏览器控制台（F12）

### 检查服务状态

```powershell
# 检查后端服务
curl http://localhost:3001/health

# 检查前端服务
curl http://localhost:5173
```

### 检查数据库

```powershell
# 检查数据库文件是否存在
dir d:\TREA\sjzx-zonghebuxian\backend\data

# 检查数据库文件大小
```

## 性能优化

### 后端优化

1. **启用 Gzip 压缩**
2. **使用缓存**
3. **优化数据库查询**
4. **使用连接池**
5. **启用 HTTP/2**

### 前端优化

1. **启用代码分割**
2. **使用懒加载**
3. **优化图片资源**
4. **启用 Gzip 压缩**
5. **使用 CDN**

### 数据库优化

1. **创建索引**
2. **定期执行 VACUUM**
3. **优化查询语句**
4. **使用事务**

## 安全配置

### 生产环境安全建议

1. **使用 HTTPS**
2. **配置防火墙**
3. **限制文件上传**
4. **定期更新依赖**
5. **启用日志审计**
6. **设置适当的文件权限**
7. **使用环境变量管理敏感信息**
8. **定期备份数据**

### 环境变量安全

- 不要将 `.env` 文件提交到版本控制系统
- 使用 `.env.example` 文件提供环境变量模板
- 生产环境使用安全的密钥管理服务

## 技术支持

如遇到其他问题，请参考：

- [后端开发文档](./backend/README.md)
- [前端开发文档](./frontend/README.md)
- [系统使用说明](../06-说明文档/使用说明文档.md)
- [项目主文档](./README.md)

---

**综合布线记录管理系统** - 让布线管理更简单、更高效