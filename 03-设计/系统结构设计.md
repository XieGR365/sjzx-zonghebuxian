# 综合布线记录管理系统 - 系统结构设计

## 1. 技术栈

### 1.1 前端
- Vue 3
- TypeScript
- Element Plus（UI组件库）
- Vue Router（路由管理）
- Axios（HTTP请求）
- Vite（构建工具）

### 1.2 后端
- Node.js
- TypeScript
- Express（Web框架）
- better-sqlite3（SQLite数据库）
- multer（文件上传）
- xlsx（Excel解析）
- cors（跨域处理）

### 1.3 数据库
- SQLite

---

## 2. 项目目录结构

```
综合布线记录管理系统/
├── backend/                    # 后端代码
│   ├── src/
│   │   ├── config/            # 配置文件
│   │   │   └── database.ts    # 数据库配置
│   │   ├── controllers/        # 控制器
│   │   │   ├── record.controller.ts
│   │   │   ├── upload.controller.ts
│   │   │   └── statistics.controller.ts  # 统计控制器（US-006）
│   │   ├── models/            # 数据模型
│   │   │   └── record.model.ts
│   │   ├── routes/            # 路由
│   │   │   ├── index.ts
│   │   │   ├── record.routes.ts
│   │   │   ├── upload.routes.ts
│   │   │   └── statistics.routes.ts  # 统计路由（US-006）
│   │   ├── services/          # 业务逻辑
│   │   │   ├── record.service.ts
│   │   │   ├── upload.service.ts
│   │   │   └── statistics.service.ts  # 统计服务（US-006）
│   │   ├── utils/             # 工具函数
│   │   │   └── excel.parser.ts
│   │   ├── app.ts             # Express应用配置
│   │   └── server.ts          # 服务器入口
│   ├── uploads/               # 上传文件目录
│   ├── data/                  # 数据库文件目录
│   ├── package.json
│   ├── tsconfig.json
│   └── .env                  # 环境变量
├── frontend/                  # 前端代码
│   ├── src/
│   │   ├── assets/           # 静态资源
│   │   ├── components/       # 组件
│   │   │   ├── RecordList.vue
│   │   │   ├── UploadFile.vue
│   │   │   ├── ParseResult.vue
│   │   │   ├── RecordDetail.vue
│   │   │   ├── FiberStatistics.vue  # 跳纤统计页（US-006）
│   │   │   └── FiberStatisticsDetail.vue  # 跳纤统计详情页（US-006）
│   │   ├── router/           # 路由
│   │   │   └── index.ts
│   │   ├── services/         # API服务
│   │   │   └── api.ts
│   │   ├── types/            # TypeScript类型定义
│   │   │   └── index.ts
│   │   ├── utils/            # 工具函数
│   │   ├── App.vue
│   │   └── main.ts
│   ├── public/
│   ├── index.html
│   ├── package.json
│   ├── tsconfig.json
│   └── vite.config.ts
├── README.md
└── .gitignore
```

---

## 3. 数据库设计

### 3.1 数据库表：records

```sql
CREATE TABLE records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    record_number TEXT NOT NULL,           -- 登记表编号
    datacenter_name TEXT NOT NULL,         -- 机房名称
    idc_requirement_number TEXT,          -- IDC需求编号
    yes_ticket_number TEXT,                -- YES工单编号
    user_unit TEXT,                        -- 用户单位
    cable_type TEXT,                       -- 线缆类型
    operator TEXT,                         -- 运营商
    circuit_number TEXT,                   -- 线路编号
    contact_person TEXT,                   -- 报障人/联系方式
    start_port TEXT,                       -- 起始端口（A端）
    hop1 TEXT,                            -- 一跳
    hop2 TEXT,                            -- 二跳
    hop3 TEXT,                            -- 三跳
    hop4 TEXT,                            -- 四跳
    hop5 TEXT,                            -- 五跳
    end_port TEXT,                         -- 目标端口（Z端）
    user_cabinet TEXT,                     -- 用户机柜
    label_complete INTEGER DEFAULT 0,       -- 线路标签是否齐全 (0:否, 1:是)
    cable_standard INTEGER DEFAULT 0,         -- 线路是否规范 (0:否, 1:是)
    status TEXT DEFAULT 'active',          -- 线路状态 (active:在用, removed:已拆除) - US-006
    remark TEXT,                           -- 备注
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_datacenter_name ON records(datacenter_name);
CREATE INDEX idx_record_number ON records(record_number);
CREATE INDEX idx_circuit_number ON records(circuit_number);
CREATE INDEX idx_start_port ON records(start_port);
CREATE INDEX idx_end_port ON records(end_port);
CREATE INDEX idx_user_cabinet ON records(user_cabinet);
CREATE INDEX idx_operator ON records(operator);
CREATE INDEX idx_cable_type ON records(cable_type);
CREATE INDEX idx_status ON records(status);

-- 重复识别索引（用于US-005重复记录处理）
CREATE INDEX idx_idc_requirement_number ON records(idc_requirement_number);
CREATE INDEX idx_yes_ticket_number ON records(yes_ticket_number);
CREATE UNIQUE INDEX idx_unique_record ON records(
    COALESCE(idc_requirement_number, ''),
    COALESCE(yes_ticket_number, ''),
    COALESCE(circuit_number, ''),
    COALESCE(record_number, ''),
    datacenter_name
);
```

### 3.2 数据库表：operation_logs（操作日志表）

```sql
CREATE TABLE operation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operation_type TEXT NOT NULL,           -- 操作类型：INSERT, UPDATE, DELETE
    record_id INTEGER,                       -- 记录ID
    record_number TEXT,                      -- 登记表编号
    idc_requirement_number TEXT,             -- IDC需求编号
    yes_ticket_number TEXT,                  -- YES工单编号
    circuit_number TEXT,                     -- 线路编号
    datacenter_name TEXT,                    -- 机房名称
    operation_detail TEXT,                   -- 操作详情（JSON格式）
    old_data TEXT,                           -- 旧数据（JSON格式，仅UPDATE操作）
    new_data TEXT,                           -- 新数据（JSON格式）
    operator TEXT,                           -- 操作人
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_operation_type ON operation_logs(operation_type);
CREATE INDEX idx_record_id ON operation_logs(record_id);
CREATE INDEX idx_created_at ON operation_logs(created_at);
```

---

## 4. API接口设计

### 4.1 记录查询接口

#### 获取记录列表
- **接口：** `GET /api/records`
- **参数：**
  - `page`: 页码（默认1）
  - `pageSize`: 每页数量（默认50）
  - `datacenterNames`: 机房名称数组（可选）
  - `keyword`: 关键字（可选）
  - `cableType`: 线缆类型（可选）
  - `operator`: 运营商（可选）
  - `labelComplete`: 标签齐全（可选）
  - `cableStandard`: 线路规范（可选）
- **返回：**
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": 1,
        "recordNumber": "WL-001",
        "datacenterName": "临港机房",
        "userUnit": "东方有线",
        "circuitNumber": "4705764620ShH",
        "startPort": "丽正路老芦公路光交",
        "endPort": "101机房G01"
      }
    ],
    "total": 156,
    "page": 1,
    "pageSize": 50
  }
}
```

#### 获取记录详情
- **接口：** `GET /api/records/:id`
- **参数：**
  - `id`: 记录ID
- **返回：**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "recordNumber": "WL-001",
    "datacenterName": "临港机房",
    "idcRequirementNumber": "RWD-20250805-065",
    "yesTicketNumber": "QTJF-202508-2354",
    "userUnit": "东方有线",
    "cableType": "单模光纤",
    "operator": "OCN",
    "circuitNumber": "4705764620ShH",
    "contactPerson": "400-884-1883",
    "startPort": "丽正路老芦公路光交",
    "hop1": "接入间A-A01-ODF3-1/2",
    "hop2": "接入间A-A04-ODF3-1#1/2",
    "hop3": "-",
    "hop4": "-",
    "hop5": "-",
    "endPort": "101机房G01",
    "userCabinet": "-",
    "labelComplete": 1,
    "cableStandard": 1,
    "remark": "-",
    "createdAt": "2025-12-24 10:30:00"
  }
}
```

---

### 4.2 文件上传接口

#### 上传文件
- **接口：** `POST /api/upload`
- **参数：**
  - `file`: Excel文件
- **返回：**
```json
{
  "success": true,
  "data": {
    "fileId": "1234567890",
    "fileName": "临港机房布线记录.xlsx",
    "recordCount": 25
  }
}
```

---

### 4.3 文件解析接口

#### 解析文件
- **接口：** `POST /api/parse`
- **参数：**
```json
{
  "fileId": "1234567890"
}
```
- **返回：**
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "datacenterName": "临港机房",
        "userUnit": "东方有线",
        "circuitNumber": "4705764620",
        "startPort": "丽正路...",
        "endPort": "101机房"
      }
    ],
    "total": 25
  }
}
```

---

### 4.4 保存记录接口

#### 保存记录
- **接口：** `POST /api/records`
- **参数：**
```json
{
  "fileId": "1234567890",
  "records": [
    {
      "datacenterName": "临港机房",
      "userUnit": "东方有线",
      "circuitNumber": "4705764620",
      "startPort": "丽正路...",
      "endPort": "101机房"
    }
  ]
}
```
- **返回：**
```json
{
  "success": true,
  "data": {
    "savedCount": 25,
    "updatedCount": 10,
    "failedCount": 0,
    "duplicateRecords": [
      {
        "idcRequirementNumber": "RWD-20250805-065",
        "yesTicketNumber": "QTJF-202508-2354",
        "circuitNumber": "4705764620",
        "operation": "UPDATE"
      }
    ]
  }
}
```

**重复处理说明（US-005）：**
- 系统自动检测重复记录
- 重复识别优先级：
  1. 任务单需求编号（IDC需求编号）
  2. YES工单编号
  3. 链路编号（线路编号）
  4. 登记表编号
  5. 组合键：机房名称 + 线路编号
  6. 组合键：机房名称 + 用户单位 + 线路编号
- 发现重复时执行UPDATE操作，保留原记录的created_at，更新updated_at
- 非重复记录执行INSERT操作
- 记录所有操作到operation_logs表

---

### 4.5 跳纤统计接口（US-006）

#### 获取跳纤统计
- **接口：** `GET /api/statistics/fiber`
- **参数：**
  - `datacenterName`: 机房名称（可选）
  - `status`: 线路状态（可选，all/active/removed）
- **返回：**
```json
{
  "success": true,
  "data": {
    "statistics": [
      {
        "datacenterName": "临港机房",
        "totalCount": 45,
        "activeCount": 38,
        "removedCount": 7,
        "activePercentage": 84.44,
        "removedPercentage": 15.56
      },
      {
        "datacenterName": "金桥机房",
        "totalCount": 32,
        "activeCount": 28,
        "removedCount": 4,
        "activePercentage": 87.5,
        "removedPercentage": 12.5
      }
    ],
    "summary": {
      "totalDatacenters": 7,
      "totalCount": 156,
      "activeCount": 132,
      "removedCount": 24
    }
  }
}
```

#### 获取机房跳纤详情
- **接口：** `GET /api/statistics/fiber/:datacenterName`
- **参数：**
  - `datacenterName`: 机房名称
  - `status`: 线路状态（可选，all/active/removed）
  - `page`: 页码（默认1）
  - `pageSize`: 每页数量（默认50）
- **返回：**
```json
{
  "success": true,
  "data": {
    "datacenterName": "临港机房",
    "records": [
      {
        "id": 1,
        "recordNumber": "WL-001",
        "circuitNumber": "4705764620",
        "startPort": "丽正路老芦公路光交",
        "endPort": "101机房G01",
        "status": "active",
        "userUnit": "东方有线"
      }
    ],
    "total": 45,
    "activeCount": 38,
    "removedCount": 7,
    "page": 1,
    "pageSize": 50
  }
}
```

#### 导出跳纤统计报表
- **接口：** `GET /api/statistics/fiber/export`
- **参数：**
  - `datacenterName`: 机房名称（可选）
  - `status`: 线路状态（可选，all/active/removed）
- **返回：**
  - Excel文件下载

---

## 5. 前端路由设计

```typescript
const routes = [
  { path: '/', redirect: '/records' },
  { path: '/records', component: RecordList },
  { path: '/upload', component: UploadFile },
  { path: '/parse-result/:fileId', component: ParseResult },
  { path: '/record/:id', component: RecordDetail },
  { path: '/statistics', component: FiberStatistics },
  { path: '/statistics/:datacenterName', component: FiberStatisticsDetail }
]
```

---

## 6. 前端组件设计

### 6.1 RecordList.vue
- 机房筛选组件
- 关键字查询组件
- 精确筛选组件
- 数据表格组件
- 分页组件

### 6.2 UploadFile.vue
- 文件上传组件
- 进度条组件

### 6.3 ParseResult.vue
- 解析结果表格组件
- 操作按钮组件

### 6.4 RecordDetail.vue
- 记录详情组件

### 6.5 FiberStatistics.vue（US-006）
- 统计卡片网格组件
- 机房筛选组件
- 状态筛选组件
- 导出按钮组件
- 统计数据展示组件

### 6.6 FiberStatisticsDetail.vue（US-006）
- 机房详情头部组件
- 跳纤记录表格组件
- 状态筛选组件
- 分页组件

---

## 7. 后端服务设计

### 7.1 record.service.ts
- 查询记录列表（支持多条件组合查询）
- 获取记录详情
- 保存记录（支持重复检测和UPSERT操作）
- 统计记录数量
- 重复记录检测（US-005）
- 记录操作日志（US-005）

**重复检测逻辑（US-005）：**
```typescript
// 重复识别优先级
function detectDuplicate(record: Record): Record | null {
  // 优先级1：任务单需求编号（IDC需求编号）
  if (record.idcRequirementNumber) {
    const existing = findByIDCRequirementNumber(record.idcRequirementNumber);
    if (existing) return existing;
  }
  
  // 优先级2：YES工单编号
  if (record.yesTicketNumber) {
    const existing = findByYesTicketNumber(record.yesTicketNumber);
    if (existing) return existing;
  }
  
  // 优先级3：链路编号（线路编号）
  if (record.circuitNumber) {
    const existing = findByCircuitNumber(record.circuitNumber);
    if (existing) return existing;
  }
  
  // 优先级4：登记表编号
  if (record.recordNumber) {
    const existing = findByRecordNumber(record.recordNumber);
    if (existing) return existing;
  }
  
  // 优先级5：组合键 - 机房名称 + 线路编号
  if (record.circuitNumber && record.datacenterName) {
    const existing = findByDatacenterAndCircuit(
      record.datacenterName, 
      record.circuitNumber
    );
    if (existing) return existing;
  }
  
  // 优先级6：组合键 - 机房名称 + 用户单位 + 线路编号
  if (record.circuitNumber && record.datacenterName && record.userUnit) {
    const existing = findByDatacenterAndUnitAndCircuit(
      record.datacenterName,
      record.userUnit,
      record.circuitNumber
    );
    if (existing) return existing;
  }
  
  return null;
}

// 保存记录（支持UPSERT）
function saveRecord(record: Record): SaveResult {
  const existing = detectDuplicate(record);
  
  if (existing) {
    // 更新现有记录
    updateRecord(existing.id, record);
    logOperation('UPDATE', existing.id, record);
    return { operation: 'UPDATE', recordId: existing.id };
  } else {
    // 插入新记录
    const newId = insertRecord(record);
    logOperation('INSERT', newId, record);
    return { operation: 'INSERT', recordId: newId };
  }
}
```

### 7.2 upload.service.ts
- 上传文件
- 解析Excel文件
- 生成文件ID
- 批量保存记录（支持重复检测）
- 统计处理结果（新增、更新、失败数量）

**批量保存逻辑（US-005）：**
```typescript
function batchSaveRecords(records: Record[]): BatchSaveResult {
  const result = {
    savedCount: 0,
    updatedCount: 0,
    failedCount: 0,
    duplicateRecords: []
  };
  
  for (const record of records) {
    try {
      const saveResult = saveRecord(record);
      if (saveResult.operation === 'INSERT') {
        result.savedCount++;
      } else if (saveResult.operation === 'UPDATE') {
        result.updatedCount++;
        result.duplicateRecords.push({
          idcRequirementNumber: record.idcRequirementNumber,
          yesTicketNumber: record.yesTicketNumber,
          circuitNumber: record.circuitNumber,
          operation: 'UPDATE'
        });
      }
    } catch (error) {
      result.failedCount++;
    }
  }
  
  return result;
}
```

### 7.3 statistics.service.ts（US-006）
- 获取跳纤统计数据
- 按机房分组统计
- 按线路状态统计（在用/已拆除）
- 计算状态占比
- 导出统计报表

**跳纤统计逻辑（US-006）：**
```typescript
// 获取跳纤统计
function getFiberStatistics(filters: StatisticsFilters): FiberStatistics {
  const query = buildStatisticsQuery(filters);
  const records = db.prepare(query).all();
  
  const statistics = records.reduce((acc, record) => {
    const datacenter = record.datacenter_name;
    if (!acc[datacenter]) {
      acc[datacenter] = {
        datacenterName: datacenter,
        totalCount: 0,
        activeCount: 0,
        removedCount: 0,
        activePercentage: 0,
        removedPercentage: 0
      };
    }
    
    acc[datacenter].totalCount++;
    
    // 判断线路状态（基于备注字段或新增状态字段）
    const status = determineLineStatus(record);
    if (status === 'active') {
      acc[datacenter].activeCount++;
    } else if (status === 'removed') {
      acc[datacenter].removedCount++;
    }
    
    return acc;
  }, {});
  
  // 计算百分比
  Object.values(statistics).forEach(stat => {
    stat.activePercentage = (stat.activeCount / stat.totalCount * 100).toFixed(2);
    stat.removedPercentage = (stat.removedCount / stat.totalCount * 100).toFixed(2);
  });
  
  // 计算汇总统计
  const summary = {
    totalDatacenters: Object.keys(statistics).length,
    totalCount: Object.values(statistics).reduce((sum, s) => sum + s.totalCount, 0),
    activeCount: Object.values(statistics).reduce((sum, s) => sum + s.activeCount, 0),
    removedCount: Object.values(statistics).reduce((sum, s) => sum + s.removedCount, 0)
  };
  
  return {
    statistics: Object.values(statistics),
    summary
  };
}

// 判断线路状态
function determineLineStatus(record: Record): string {
  // 方案1：基于备注字段判断
  if (record.remark && record.remark.includes('已拆除')) {
    return 'removed';
  }
  
  // 方案2：基于新增状态字段判断（推荐）
  // if (record.status === 'removed') {
  //   return 'removed';
  // }
  
  return 'active';
}

// 导出统计报表
function exportFiberStatistics(filters: StatisticsFilters): Buffer {
  const statistics = getFiberStatistics(filters);
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('跳纤统计');
  
  worksheet.columns = [
    { header: '机房名称', key: 'datacenterName' },
    { header: '跳纤总数', key: 'totalCount' },
    { header: '在用数量', key: 'activeCount' },
    { header: '已拆除数量', key: 'removedCount' },
    { header: '在用占比', key: 'activePercentage' },
    { header: '已拆除占比', key: 'removedPercentage' }
  ];
  
  statistics.statistics.forEach(stat => {
    worksheet.addRow(stat);
  });
  
  return workbook.xlsx.writeBuffer();
}
```

---

## 8. 数据字典

### 8.1 机房列表
- 临港机房
- 金桥机房
- 国定机房
- 唐镇机房
- 美盛机房
- 通联机房
- 深圳云引擎机房

### 8.2 线缆类型
- 单模光纤
- 多模光纤
- 网线

### 8.3 运营商
- OCN
- 电信
- 移动
- 联通

---

## 9. 开发流程

### 9.1 后端开发
1. 初始化Node.js项目
2. 安装依赖
3. 创建数据库表
4. 实现数据模型
5. 实现业务逻辑
6. 实现API接口
7. 测试API

### 9.2 前端开发
1. 初始化Vue项目
2. 安装依赖
3. 创建组件
4. 实现路由
5. 实现API调用
6. 实现界面
7. 测试功能

---

## 10. 部署说明

### 10.1 本地开发
1. 启动后端服务：`cd backend && npm run dev`
2. 启动前端服务：`cd frontend && npm run dev`
3. 访问：`http://localhost:5173`

### 10.2 生产部署
1. 构建前端：`cd frontend && npm run build`
2. 配置后端静态文件服务
3. 启动后端服务：`cd backend && npm start`

---

## 11. 备注

- 系统设计遵循简洁、实用的原则
- 支持多机房数据统一管理和查询
- 查询功能是核心，支持灵活的查询条件组合
- 数据库使用SQLite，适合单用户、小规模数据
- 前后端分离开发，便于维护和扩展
